<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YOKU MOKU çµå¸³</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,sans-serif;background:#1e3a5f;min-height:100vh;color:#f5f0eb;padding:10px;font-size:18px;font-weight:bold}
    h1{text-align:center;font-size:1.8rem;margin-bottom:10px;color:#fff;font-weight:bold}
    .tabs{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px}
    .tabs button{padding:10px 16px;border:none;border-radius:6px;background:#374151;color:#fff;font-size:17px;cursor:pointer;font-weight:bold}
    .tabs button.active{background:#699ab0;color:#fff;font-weight:bold}
    .member-section{background:#374151;padding:10px;border-radius:8px;margin-bottom:10px}
    .member-row{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .member-row button{padding:8px 14px;border:none;border-radius:5px;font-size:16px;cursor:pointer;background:#4b5563;color:#f5f0eb}
    .member-row button.active{background:#50818e;color:#f5f0eb;font-weight:bold}
    .member-row label{font-size:16px;display:flex;align-items:center;gap:4px;color:#fde047}
    .section{margin-bottom:10px}
    .section h2{font-size:17px;margin-bottom:6px;color:#f5f0eb;font-weight:bold}
    .product-row{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:6px;margin-bottom:5px;background:#435caa}
    .product-row.combo{background:#951c4e}
    .product-row.special{background:#236695}
    .product-row.addon{background:#8d4a2f}
    .product-row.wood{background:#78350f}
    .product-row.cookie{background:#065f46}
    .product-row.cake{background:#854d0e}
    .product-row.drink{background:#155c82}
    .product-row.bag{background:#3a5775}
    .product-row.brown1{background:#246899}
    .product-row.brown2{background:#63594f}
    .product-row.brown3{background:#78350f}
    .product-row.brown4{background:#713f12}
    .product-row.brown5{background:#477663}
    .product-row.brown6{background:#854d0e}
    .product-row .info{flex:1;min-width:0}
    .product-row .name{font-size:17px;font-weight:bold;color:#f5f0eb;margin-bottom:6px}
    .product-row .price{color:#fcf405;font-weight:bold;font-size:18px}
    .qty-ctrl{display:flex;align-items:center;gap:3px}
    .qty-ctrl button{width:36px;height:36px;border:none;border-radius:5px;font-size:20px;font-weight:bold;color:#f5f0eb;cursor:pointer}
    .qty-ctrl .minus{background:#b7a7a8}
    .qty-ctrl .plus{background:#34251f}
    .qty-ctrl input{width:50px;height:36px;text-align:center;border:none;border-radius:4px;font-size:18px;background:#fff;color:#34251f}
    .cart{background:#1f2937;border-radius:8px;padding:10px;margin-bottom:10px}
    .cart h3{font-size:18px;margin-bottom:8px;color:#fde047;font-weight:bold}
    .cart-item{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;margin-bottom:2px;font-size:16px;background:#374151;border-radius:4px}
    .item-name{color:#e5e7eb;flex:1}
    .item-price{display:flex;gap:6px;align-items:center}
    .price-orig{color:#9ca3af;text-decoration:line-through;font-size:15px}
    .price-final{color:#4ade80;font-weight:bold;font-size:17px}
    .cat-title{color:#60a5fa;font-size:15px;font-weight:bold;margin:10px 0 4px 0;padding-bottom:2px;border-bottom:1px solid #4b5563}
    .divider{border-top:2px solid #4b5563;margin:10px 0}
    .summary{background:#374151;padding:8px;border-radius:6px;margin-bottom:8px}
    .summary-row{display:flex;justify-content:space-between;padding:4px 0;font-size:17px;color:#e5e7eb}
    .summary-row.total{font-size:24px;font-weight:bold;padding-top:6px;border-top:1px solid #4b5563;margin-top:4px}
    .clear-btn{width:100%;background:#6d6059;border:none;color:#f5f0eb;padding:14px;border-radius:6px;font-size:18px;font-weight:bold;cursor:pointer;margin-bottom:8px}
    .note{font-size:15px;color:#fdba74;margin-top:4px}
    .discount-info{background:#374151;padding:8px 12px;border-radius:6px;margin-bottom:8px;font-size:15px;color:#e5e7eb}
    .loading{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);padding:20px;border-radius:8px;z-index:1000;display:none}
    .loading.show{display:block}
    @media (max-width: 600px) {
      body{font-size:20px}
      h1{font-size:2rem}
      .tabs button{font-size:18px;padding:12px 18px}
      .product-row .name{font-size:18px}
      .product-row .price{font-size:20px}
      .cart h3{font-size:20px}
      .cart-item{font-size:18px}
      .summary-row{font-size:19px}
      .summary-row.total{font-size:26px}
      .clear-btn{font-size:20px;padding:16px}
      .qty-ctrl button{width:40px;height:40px;font-size:22px}
      .qty-ctrl input{width:55px;height:40px;font-size:20px}
    }
  </style>
</head>
<body>
  <h1>YOKU MOKU çµå¸³</h1>
  <div class="loading" id="loading">è¼‰å…¥ä¸­...</div>
  <div id="app">è¼‰å…¥ä¸­...</div>
<script>
// âš™ï¸ è¨­å®šï¼šè«‹å°‡æ­¤ç¶²å€æ”¹ç‚ºæ‚¨çš„ Google Apps Script ç¶²å€
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzK4Qm1Y65JSbNSUxxrm1J5Ig_cOV_hAKGOTrb5VsXMyyxb-_go8YMAj3sgjvRLglV6Og/exec';

window.DATA={
  records:{name:'ğŸ“Šè¨˜éŒ„'},
  christmas:{
    name:'ğŸ„è–èª•',
    box:[
      {id:'YCG-DXM',name:'è–èª•åŸå‘³é›ªèŒ„20å…¥',price:950},
      {id:'YAN-A',name:'è–„ç‰‡æ¿ƒå·§é›™æ‹¼ç¦®ç›’24å…¥',price:850},
      {id:'YCN-A',name:'è–èª•å¯Œæ‹¼ç¦®ç›’28å…¥',price:1380},
      {id:'YCN-B',name:'é›ªèŒ„è–„ç‰‡é›™æ‹¼ç¦®ç›’44å…¥',price:2050},
      {id:'YHD-A',name:'è–èª•è‡»é¥Œ30å…¥',price:1500},
      {id:'YHD-B',name:'è–èª•å–œé¥Œ50å…¥',price:2100}
    ],
    bag:[
      {id:'YCG-AXM',name:'è–èª•åŸå‘³é›ªèŒ„10å…¥',price:420},
      {id:'YBL-AXM',name:'è–èª•å·§å…‹åŠ›è–„ç‰‡é¤…ä¹¾12å…¥',price:420}
    ],
    combo:[
      {id:'XMAS-1',name:'è–èª•é›ªèŒ„è–„ç‰‡é›™æ‹¼å–®ç›’',price:1800,orig:2050},
      {id:'XMAS-2',name:'è–èª•é›ªèŒ„è–„ç‰‡é›™æ‹¼é›™ç›’',price:3500,orig:4100},
      {id:'YCN-A-2',name:'ğŸŒŸå¯Œæ‹¼2ç›’å„ªæƒ ',price:2500,orig:2760}
    ],
    special:[
      {id:'CHOCO18',name:'18å…¥å·§å…‹åŠ›é›ªèŒ„',price:660,orig:1120},
      {id:'CHOCO8',name:'8å…¥å·§å…‹åŠ›é›ªèŒ„',price:300}
    ],
    bagroll:[
      {id:'YCG-D-2',name:'YCG-D 2ç›’ å„ªæƒ ',price:1500,orig:1840},
      {id:'YCG-AXM-5',name:'è–èª•æˆ–å¸¸è¦-10å…¥è¢‹è£ï¼Œäº”åŒ…',price:1800,orig:2100}
    ],
    addon:[
    ]
  },
  giftbox:{
    name:'ğŸç¦®ç›’',
    general:[
      {id:'G1',name:'è‡»é¥Œæ¿ƒå·§ç¦®ç›’',price:1280},
      {id:'G3',name:'å–œé¥Œæ¿ƒå·§ç¦®ç›’',price:1980},
      {id:'G4',name:'ç››é¥Œæ¿ƒå·§ç¦®ç›’',price:2580},
      {id:'G6',name:'ç‰¹é¥Œæ¿ƒå·§ç¦®ç›’',price:2980}
    ],
    double:[
      {id:'G2',name:'é›ªèŒ„è–„ç‰‡æ¿ƒå·§é›™æ‹¼ç¦®ç›’',price:1880},
      {id:'G5',name:'é›ªèŒ„è–„ç‰‡æ¿ƒå·§ç‰¹é›™æ‹¼ç¦®ç›’',price:2880}
    ]
  },
  cigare:{
    name:'ğŸ¥šè›‹æ²',
    original_small:[
      {id:'C1',name:'åŸå‘³é›ªèŒ„è›‹æ²10å…¥',price:400},
      {id:'C2',name:'åŸå‘³é›ªèŒ„è›‹æ²14å…¥',price:620},
      {id:'PANDA16',name:'ç†Šè²“è¿·ä½ é›ªèŒ„16å…¥',price:580}
    ],
    original_20:[
      {id:'YCG-D',name:'åŸå‘³é›ªèŒ„è›‹æ²(20å…¥)',price:920},
      {id:'YCG-DR',name:'å–œé¥Œ(20å…¥)',price:920},
      {id:'YCG-DJ',name:'ã€å¯Œå£«å±±ã€‘åŸå‘³é›ªèŒ„è›‹æ²(20å…¥)',price:920},
      {id:'YCG-DTW',name:'ã€å°ç£é™å®šã€‘å¹¸ç¦æˆé›™åŸå‘³é›ªèŒ„è›‹æ²20å…¥',price:920}
    ],
    original_large:[
      {id:'C4',name:'åŸå‘³é›ªèŒ„è›‹æ²30å…¥',price:1320},
      {id:'C5',name:'åŸå‘³é›ªèŒ„è›‹æ²48å…¥',price:2020}
    ],
    chocolate:[
      {id:'C6',name:'å·§å…‹åŠ›é›ªèŒ„è›‹æ²8å…¥',price:480},
      {id:'C7',name:'å·§å…‹åŠ›é›ªèŒ„è›‹æ²18å…¥',price:1120}
    ]
  },
  autumn:{
    name:'ğŸ‚ç§‹å†¬æ¿ƒå·§è–„ç‰‡',
    items:[
      {id:'A1',name:'é›™å±¤å·§å…‹åŠ›è–„ç‰‡é¤…ä¹¾12å…¥',price:400},
      {id:'A2',name:'é›™å±¤å·§å…‹åŠ›é¤…ä¹¾ç¦®ç›’',price:820},
      {id:'A3',name:'æä»è–„ç‰‡é¤…ä¹¾ç¦®ç›’',price:820},
      {id:'A5',name:'åœ“æœˆç…é¤…ä¹¾ç¦®ç›’',price:820},
      {id:'A4',name:'å¤å¨å¤·è±†å·§å…‹åŠ›é¤…ä¹¾ç¦®ç›’',price:920}
    ]
  },
  baton:{
    name:'ğŸªé¤…ä¹¾æ£’',
    items:[
      {id:'B1',name:'ç„™èŒ¶æ‹¿éµé¤…ä¹¾æ£’',price:520},
      {id:'B2',name:'å¥¶æ²¹é¤…ä¹¾æ£’',price:520}
    ]
  },
  wood:{
    name:'ğŸªµæœ¨ç›’',
    items:[
      {id:'W1',name:'æ²ç¦¾ç¦®ç›’-å°',price:580},
      {id:'W2',name:'æ²ç¦¾ç¦®ç›’-ä¸­',price:880},
      {id:'W3',name:'æ²ç¦¾ç¦®ç›’-å¤§',price:1580}
    ]
  },
  tea:{
    name:'â˜•ä¸‹åˆèŒ¶',
    cake:[
      {id:'T1',name:'å—é’å±±ç”Ÿä¹³æ²',price:220},
      {id:'T2',name:'è‰è“æµ·ç¶¿è›‹ç³•',price:280},
      {id:'T3',name:'å·§å…‹åŠ›å¥¶æ²¹è›‹ç³•',price:280},
      {id:'T4',name:'è’™å¸ƒæœ—è›‹ç³•',price:320},
      {id:'T5',name:'æŠ¹èŒ¶ææ‹‰ç±³è˜‡',price:320}
    ],
    drink:[
      {id:'D1',name:'ç¶“å…¸æ‰‹æ²–å’–å•¡',price:150},
      {id:'D2',name:'ä¼Šè—¤åœ’èœ‚èœœç´…èŒ¶',price:150},
      {id:'D3',name:'ä¼Šè—¤åœ’ç‰¹é¸æ—¥å¼ç¶ èŒ¶',price:150},
      {id:'D4',name:'TWGè‹±å¼ç´…èŒ¶',price:150}
    ],
    roll:[
      {id:'T6',name:'ä¸€æ²å—å±±ç”Ÿä¹³æ²(å†·å‡)',price:920}
    ]
  }
};

// å¾ localStorage è¼‰å…¥æš«å­˜è³‡æ–™
function loadState(){
  try{
    const saved = localStorage.getItem('YOKU_MOKU_STATE');
    if(saved){
      const data = JSON.parse(saved);
      console.log('ğŸ“¥ è¼‰å…¥æš«å­˜è³‡æ–™:', data);
      return data;
    }
  }catch(e){
    console.error('è¼‰å…¥æš«å­˜å¤±æ•—:', e);
  }
  return null;
}

// å„²å­˜è³‡æ–™åˆ° localStorage
function saveState(){
  try{
    const data = {
      cart: window.S.cart,
      tab: window.S.tab,
      xm: window.S.xm,
      m: window.S.m,
      bd: window.S.bd,
      tv: window.S.tv,
      tb: window.S.tb,
      td: window.S.td,
      giftProduct: window.S.giftProduct,
      giftQty: window.S.giftQty,
      teaGiftDiscount: window.S.teaGiftDiscount
    };
    localStorage.setItem('YOKU_MOKU_STATE', JSON.stringify(data));
    console.log('ğŸ’¾ æš«å­˜å·²å„²å­˜');
  }catch(e){
    console.error('å„²å­˜æš«å­˜å¤±æ•—:', e);
  }
}

// æ¸…é™¤æš«å­˜
function clearState(){
  localStorage.removeItem('YOKU_MOKU_STATE');
  console.log('ğŸ—‘ï¸ æš«å­˜å·²æ¸…é™¤');
}

// åˆå§‹åŒ–ç‹€æ…‹ï¼ˆå„ªå…ˆä½¿ç”¨æš«å­˜è³‡æ–™ï¼‰
const savedState = loadState();
window.S = savedState || {cart:{},tab:'christmas',xm:false,m:'normal',bd:false,tv:0,tb:0,td:1,h:[],manualAmount:0,notes:'',giftProduct:'',giftQty:0,teaGiftDiscount:false};
if(!window.S.h) window.S.h = [];
if(window.S.manualAmount===undefined) window.S.manualAmount = 0;
if(window.S.notes===undefined) window.S.notes = '';
if(window.S.giftProduct===undefined) window.S.giftProduct = '';
if(window.S.giftQty===undefined) window.S.giftQty = 0;
if(window.S.teaGiftDiscount===undefined) window.S.teaGiftDiscount = false;

// Debounce å‡½æ•¸ - é˜²æ­¢é »ç¹å‘¼å«é€ æˆç•¶æ©Ÿ
let saveDebounceTimer;
function debouncedSave(){
  clearTimeout(saveDebounceTimer);
  saveDebounceTimer = setTimeout(()=>{
    saveState();
  }, 300); // 300ms å»¶é²
}

function formatTime(date){
  const h=date.getHours();
  const m=date.getMinutes();
  const period=h<12?'ä¸Šåˆ':'ä¸‹åˆ';
  const h12=h%12||12;
  const mm=m<10?'0'+m:m;
  return period+h12+':'+mm;
}

function formatDateTime(date){
  const y=date.getFullYear();
  const mo=date.getMonth()+1;
  const d=date.getDate();
  const h=date.getHours();
  const m=date.getMinutes();
  const hh=h<10?'0'+h:h;
  const mm=m<10?'0'+m:m;
  return y+'/'+mo+'/'+d+' '+hh+':'+mm;
}

function showLoading(){document.getElementById('loading').classList.add('show')}
function hideLoading(){document.getElementById('loading').classList.remove('show')}

async function loadRecords(){
  if(!SCRIPT_URL || SCRIPT_URL==='YOUR_GOOGLE_APPS_SCRIPT_URL_HERE'){
    console.log('è«‹å…ˆè¨­å®š Google Apps Script URL');
    return;
  }
  try{
    showLoading();
    const res=await fetch(SCRIPT_URL+'?action=getRecords');
    const data=await res.json();
    window.S.h=(data.records||[]).map(r=>{
      // ç¢ºä¿æ™‚é–“æ ¼å¼æ­£ç¢º
      let timeStr = r.time;
      if(timeStr && typeof timeStr === 'string' && timeStr.includes('T')){
        // å¦‚æœæ˜¯ISOæ ¼å¼ï¼Œè½‰æ›æˆæœ¬åœ°æ ¼å¼
        const d = new Date(timeStr);
        timeStr = formatDateTime(d);
      }
      return {
        ...r,
        time: timeStr,
        dragon: r.dragon||false,
        productItems: r.productItems||[],
        teaItems: r.teaItems||[],
        notes: r.notes||''
      };
    });
    hideLoading();
    R();
  }catch(e){
    hideLoading();
    console.error('è¼‰å…¥è¨˜éŒ„å¤±æ•—',e);
  }
}

async function saveRecord(record){
  try{
    console.log('ğŸ’¾ é–‹å§‹å„²å­˜è¨˜éŒ„åˆ° Google Sheets');
    console.log('SCRIPT_URL:', SCRIPT_URL);
    console.log('è¨˜éŒ„å…§å®¹:', record);

    if(SCRIPT_URL==='YOUR_GOOGLE_APPS_SCRIPT_URL_HERE'){
      alert('âš ï¸ è«‹å…ˆè¨­å®š Google Apps Script URLï¼\nåœ¨ HTML ç¬¬ 83 è¡Œ');
      hideLoading();
      return;
    }

    showLoading();
    const body = new URLSearchParams();
    body.append('action','addRecord');
    body.append('record', JSON.stringify(record));

    console.log('ç™¼é€è«‹æ±‚åˆ°:', SCRIPT_URL);
    const response = await fetch(SCRIPT_URL,{method:'POST',body:body});
    console.log('å„²å­˜å›æ‡‰ç‹€æ…‹:', response.status);

    const responseText = await response.text();
    console.log('å„²å­˜å›æ‡‰å…§å®¹:', responseText);

    await loadRecords();
    hideLoading();
  }catch(e){
    hideLoading();
    console.error('å„²å­˜éŒ¯èª¤:', e);
    alert('å„²å­˜å¤±æ•—ï¼š'+e.message);
  }
}

async function toggleDragon(idx){
  window.S.h[idx].dragon=!window.S.h[idx].dragon;
  R();

  // æ›´æ–° Google Sheets ä¸­çš„ç¥¥é¾ç‹€æ…‹
  try{
    const body = new URLSearchParams();
    body.append('action','updateDragon');
    body.append('index', String(idx));
    body.append('dragon', String(window.S.h[idx].dragon));
    await fetch(SCRIPT_URL,{method:'POST',body:body});
    console.log('âœ… ç¥¥é¾ç‹€æ…‹å·²å„²å­˜åˆ° Google Sheets');
  }catch(e){
    console.error('å„²å­˜ç¥¥é¾ç‹€æ…‹å¤±æ•—:', e);
  }
}

function openTeaSummary(){
  // çµ±è¨ˆä¸‹åˆèŒ¶éŠ·å”®è³‡æ–™
  const stats = {
    cakes: {},      // è›‹ç³•çµ±è¨ˆ {name: {regular: count, voucher: count, gift: count, price: number, total: number}}
    drinks: {},     // é£²æ–™çµ±è¨ˆ {name: {regular: count, voucher: count, gift: count, price: number, total: number}}
    voucherCount: 0,  // è²´è³“åˆ¸æ•¸é‡
    birthdayCount: 0, // ç”Ÿæ—¥ç¦®æ•¸é‡
    setCount: 0,      // å¥—é¤æ•¸é‡ï¼ˆç”¨æ–¼è¨ˆç®—-$30æŠ˜æ‰£ï¼‰
    totalAmount: 0    // ç¸½é‡‘é¡
  };

  // ä¸‹åˆèŒ¶å•†å“åˆ—è¡¨ï¼ˆç”¨æ–¼åˆ¤æ–·é¡åˆ¥å’Œåƒ¹æ ¼ï¼‰
  const cakeNames = ['å—é’å±±ç”Ÿä¹³æ²', 'è‰è“æµ·ç¶¿è›‹ç³•', 'å·§å…‹åŠ›å¥¶æ²¹è›‹ç³•', 'è’™å¸ƒæœ—è›‹ç³•', 'æŠ¹èŒ¶ææ‹‰ç±³è˜‡', 'ä¸€æ²å—å±±ç”Ÿä¹³æ²(å†·å‡)'];
  const drinkNames = ['ç¶“å…¸æ‰‹æ²–å’–å•¡', 'ä¼Šè—¤åœ’èœ‚èœœç´…èŒ¶', 'ä¼Šè—¤åœ’ç‰¹é¸æ—¥å¼ç¶ èŒ¶'];

  // å•†å“åƒ¹æ ¼è¡¨
  const d = window.DATA;
  const priceMap = {};
  d.tea.cake.forEach(p => priceMap[p.name] = p.price);
  d.tea.drink.forEach(p => priceMap[p.name] = p.price);
  d.tea.roll.forEach(p => priceMap[p.name] = p.price);

  // éæ­·æ‰€æœ‰è¨˜éŒ„çš„ä¸‹åˆèŒ¶é …ç›®
  window.S.h.forEach(record=>{
    if(!record.teaItems||record.teaItems.length===0)return;

    record.teaItems.forEach(item=>{
      // è™•ç†è²´è³“åˆ¸å’Œç”Ÿæ—¥ç¦®
      if(item.includes('ğŸ‘‘è²´è³“åˆ¸')||item.includes('ğŸ‚ç”Ÿæ—¥ç¦®')){
        // æ ¼å¼: "ğŸ‘‘è²´è³“åˆ¸ (è›‹ç³•å + é£²æ–™å) -$åƒ¹æ ¼"
        const match=item.match(/[ğŸ‘‘ğŸ‚][^(]+\((.+?)\s*\+\s*(.+?)\)/);
        if(match){
          const cakeName=match[1].trim();
          const drinkName=match[2].trim();

          // åˆå§‹åŒ–è›‹ç³•çµ±è¨ˆï¼ˆåˆ†regularã€voucherã€giftï¼‰
          if(!stats.cakes[cakeName]){
            stats.cakes[cakeName]={regular:0, voucher:0, gift:0, price:priceMap[cakeName]||0, total:0};
          }
          stats.cakes[cakeName].voucher++;

          // é£²æ–™çµ±è¨ˆï¼ˆè²´è³“åˆ¸çš„é£²æ–™ä¹Ÿæ˜¯å…è²»çš„ï¼‰
          if(!stats.drinks[drinkName]){
            stats.drinks[drinkName]={regular:0, voucher:0, gift:0, price:priceMap[drinkName]||0, total:0};
          }
          stats.drinks[drinkName].voucher++;

          // è¨ˆæ•¸åˆ¸ç¨®é¡
          if(item.includes('ğŸ‘‘è²´è³“åˆ¸'))stats.voucherCount++;
          else stats.birthdayCount++;
        }
        return;
      }

      // è™•ç†è´ˆé€å•†å“
      if(item.includes('ğŸè´ˆé€:')){
        // æ ¼å¼: "ğŸè´ˆé€: productName xQty"
        const match=item.match(/ğŸè´ˆé€:\s*(.+?)\s*x(\d+)/);
        if(match){
          const productName=match[1].trim();
          const qty=parseInt(match[2]);

          // åˆ¤æ–·æ˜¯è›‹ç³•é‚„æ˜¯é£²æ–™
          if(cakeNames.includes(productName)){
            if(!stats.cakes[productName]){
              stats.cakes[productName]={regular:0, voucher:0, gift:0, price:priceMap[productName]||0, total:0};
            }
            stats.cakes[productName].gift+=qty;
          }else if(drinkNames.includes(productName)){
            if(!stats.drinks[productName]){
              stats.drinks[productName]={regular:0, voucher:0, gift:0, price:priceMap[productName]||0, total:0};
            }
            stats.drinks[productName].gift+=qty;
          }
        }
        return;
      }

      // æå–åƒ¹æ ¼ä¸¦è¨ˆå…¥ç¸½é‡‘é¡
      const priceMatch=item.match(/\$[\d,]+/);
      if(priceMatch){
        const price=parseInt(priceMatch[0].replace(/[$,]/g,''));
        stats.totalAmount+=price;
      }else{
        return; // æ²’æœ‰åƒ¹æ ¼çš„é …ç›®è·³é
      }

      // åˆ¤æ–·æ˜¯è›‹ç³•é‚„æ˜¯é£²æ–™ï¼Œä¸¦æå–å•†å“åç¨±
      if(item.includes('å¥—é¤:')){
        // å¥—é¤æ ¼å¼: "å¥—é¤: è›‹ç³•å + é£²æ–™å $400"
        const match=item.match(/å¥—é¤:\s*(.+?)\s*\+\s*(.+?)\s*\$/);
        if(match){
          const cakeName=match[1].trim();
          const drinkName=match[2].trim();

          if(!stats.cakes[cakeName]){
            stats.cakes[cakeName]={regular:0, voucher:0, gift:0, price:priceMap[cakeName]||0, total:0};
          }
          stats.cakes[cakeName].regular++;
          stats.cakes[cakeName].total += stats.cakes[cakeName].price;

          if(!stats.drinks[drinkName]){
            stats.drinks[drinkName]={regular:0, voucher:0, gift:0, price:priceMap[drinkName]||0, total:0};
          }
          stats.drinks[drinkName].regular++;
          stats.drinks[drinkName].total += stats.drinks[drinkName].price;

          // è¨ˆç®—å¥—é¤æ•¸é‡
          stats.setCount++;
        }
      }else{
        // å–®å“
        const itemName=item.replace(/\$[\d,]+/g,'').trim();
        // åˆ¤æ–·æ˜¯è›‹ç³•é‚„æ˜¯é£²æ–™
        if(itemName.includes('è›‹ç³•')||itemName.includes('æ²')||itemName.includes('ææ‹‰ç±³è˜‡')){
          if(!stats.cakes[itemName]){
            stats.cakes[itemName]={regular:0, voucher:0, gift:0, price:priceMap[itemName]||0, total:0};
          }
          stats.cakes[itemName].regular++;
          stats.cakes[itemName].total += stats.cakes[itemName].price;
        }else{
          if(!stats.drinks[itemName]){
            stats.drinks[itemName]={regular:0, voucher:0, gift:0, price:priceMap[itemName]||0, total:0};
          }
          stats.drinks[itemName].regular++;
          stats.drinks[itemName].total += stats.drinks[itemName].price;
        }
      }
    });
  });

  // è¨ˆç®—ç¸½é‡‘é¡ï¼ˆå•†å“å°è¨ˆ - å¥—é¤æŠ˜æ‰£ï¼‰
  let calculatedTotal = 0;
  Object.values(stats.cakes).forEach(c => calculatedTotal += c.total);
  Object.values(stats.drinks).forEach(d => calculatedTotal += d.total);
  calculatedTotal -= stats.setCount * 30; // æ‰£é™¤å¥—é¤æŠ˜æ‰£
  stats.totalAmount = calculatedTotal;

  // ç”Ÿæˆ HTML å…§å®¹
  const html=`<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä»Šæ—¥ä¸‹åˆèŒ¶ç¸½çµ</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,sans-serif;background:#1e3a5f;color:#f5f0eb;padding:20px;font-size:16px}
    h1{text-align:center;margin-bottom:20px;color:#fde047}
    .summary-box{background:#374151;border-radius:8px;padding:15px;margin-bottom:15px}
    .summary-title{color:#f59e0b;font-weight:bold;font-size:18px;margin-bottom:10px;border-bottom:2px solid #4b5563;padding-bottom:5px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;text-align:left;border-bottom:1px solid #4b5563}
    th{color:#f59e0b;font-weight:bold;background:#1f2937}
    td{color:#e5e7eb}
    .voucher-note{color:#fbbf24;font-size:14px;margin-left:6px}
    .total-row{display:flex;justify-content:space-between;padding:12px 0;font-size:20px;font-weight:bold;color:#fde047;border-top:2px solid #f59e0b;margin-top:10px}
    .customer-input{background:#1f2937;padding:15px;border-radius:6px;margin-top:15px}
    .input-row{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .input-row label{color:#fde047;min-width:120px;font-weight:bold}
    .input-row input,.input-row select{flex:1;padding:8px;border-radius:4px;border:1px solid #4b5563;background:#374151;color:#fff;font-size:16px}
    .calc-result{color:#4ade80;font-size:24px;font-weight:bold;margin-top:10px}
  </style>
</head>
<body>
  <h1>ğŸ“Š ä»Šæ—¥ä¸‹åˆèŒ¶ç¸½çµ</h1>

  <div class="summary-box">
    <div class="summary-title">â˜• å•†å“éŠ·å”®æ˜ç´°</div>
    <table>
      <tr>
        <th style="width:25%">é¡åˆ¥</th>
        <th style="width:35%">å•†å“</th>
        <th style="text-align:right;width:15%">æ•¸é‡</th>
        <th style="text-align:right;width:12%">å–®åƒ¹</th>
        <th style="text-align:right;width:13%">å°è¨ˆ</th>
      </tr>
      ${Object.keys(stats.cakes).length>0?Object.entries(stats.cakes).map(([name,counts],idx)=>{
        const totalCount=counts.regular+counts.voucher+counts.gift;
        const payCount=counts.regular; // åªæœ‰regularè³¼è²·çš„æ‰ç®—éŒ¢
        let details=[];
        if(counts.voucher>0)details.push('è²´è³“åˆ¸'+counts.voucher+'ä»½');
        if(counts.gift>0)details.push('è´ˆé€'+counts.gift+'ä»½');
        const countText=totalCount+' ä»½'+(details.length>0?'<span class="voucher-note">('+details.join('ã€')+')</span>':'');
        return `
      <tr>
        <td>${idx===0?'<b>ğŸ° è›‹ç³•</b>':''}</td>
        <td>${name}</td>
        <td style="text-align:right;color:#4ade80;font-weight:bold">${countText}</td>
        <td style="text-align:right;color:#9ca3af">${payCount>0?'$'+counts.price.toLocaleString():'-'}</td>
        <td style="text-align:right;color:#4ade80;font-weight:bold">${payCount>0?'$'+counts.total.toLocaleString():'-'}</td>
      </tr>`;
      }).join(''):'<tr><td><b>ğŸ° è›‹ç³•</b></td><td colspan="4">ç„¡</td></tr>'}
      <tr style="border-top:2px solid #4b5563"><td colspan="5"></td></tr>
      ${Object.keys(stats.drinks).length>0?Object.entries(stats.drinks).map(([name,counts],idx)=>{
        const totalCount=counts.regular+counts.voucher+counts.gift;
        const payCount=counts.regular; // åªæœ‰regularè³¼è²·çš„æ‰ç®—éŒ¢
        let details=[];
        if(counts.voucher>0)details.push('è²´è³“åˆ¸'+counts.voucher+'æ¯');
        if(counts.gift>0)details.push('è´ˆé€'+counts.gift+'æ¯');
        const countText=totalCount+' æ¯'+(details.length>0?'<span class="voucher-note">('+details.join('ã€')+')</span>':'');
        return `
      <tr>
        <td>${idx===0?'<b>â˜• é£²æ–™</b>':''}</td>
        <td>${name}</td>
        <td style="text-align:right;color:#4ade80;font-weight:bold">${countText}</td>
        <td style="text-align:right;color:#9ca3af">${payCount>0?'$'+counts.price.toLocaleString():'-'}</td>
        <td style="text-align:right;color:#4ade80;font-weight:bold">${payCount>0?'$'+counts.total.toLocaleString():'-'}</td>
      </tr>`;
      }).join(''):'<tr><td><b>â˜• é£²æ–™</b></td><td colspan="4">ç„¡</td></tr>'}
      ${stats.setCount>0?`
      <tr style="border-top:2px solid #4b5563">
        <td colspan="2" style="text-align:right;color:#f59e0b;font-weight:bold">å¥—é¤æŠ˜æ‰£</td>
        <td style="text-align:right;color:#f59e0b;font-weight:bold">${stats.setCount} å¥—</td>
        <td style="text-align:right;color:#9ca3af">-$30</td>
        <td style="text-align:right;color:#f87171;font-weight:bold">-$${(stats.setCount*30).toLocaleString()}</td>
      </tr>
      `:''}
    </table>
  </div>

  <div class="summary-box">
    <div class="total-row">
      <span>ç¸½é‡‘é¡</span>
      <span>$${stats.totalAmount.toLocaleString()}</span>
    </div>
  </div>

  <div class="summary-box">
    <div class="summary-title">ğŸ è´ˆé€ + è²´è³“åˆ¸çµ±è¨ˆ</div>
    <div style="padding:10px">
      <div style="margin-bottom:15px">
        <div style="color:#f59e0b;font-weight:bold;font-size:16px;margin-bottom:8px">ğŸ° è›‹ç³•</div>
        ${Object.entries(stats.cakes).filter(([name,counts])=>counts.voucher>0||counts.gift>0).length>0
          ?Object.entries(stats.cakes).filter(([name,counts])=>counts.voucher>0||counts.gift>0).map(([name,counts])=>{
            const freeCount=counts.voucher+counts.gift;
            return '<div style="color:#e5e7eb;padding:4px 0;padding-left:20px">'+name+'ï¼š'+freeCount+' å¡Š</div>';
          }).join('')
          :'<div style="color:#666;padding-left:20px;font-style:italic">ç„¡</div>'}
      </div>
      <div>
        <div style="color:#f59e0b;font-weight:bold;font-size:16px;margin-bottom:8px">â˜• é£²æ–™</div>
        ${Object.entries(stats.drinks).filter(([name,counts])=>counts.voucher>0||counts.gift>0).length>0
          ?Object.entries(stats.drinks).filter(([name,counts])=>counts.voucher>0||counts.gift>0).map(([name,counts])=>{
            const freeCount=counts.voucher+counts.gift;
            return '<div style="color:#e5e7eb;padding:4px 0;padding-left:20px">'+name+'ï¼š'+freeCount+' æ¯</div>';
          }).join('')
          :'<div style="color:#666;padding-left:20px;font-style:italic">ç„¡</div>'}
      </div>
    </div>
  </div>

  <div class="customer-input">
    <div class="input-row">
      <label>ä¾†å®¢æ•¸ï¼š</label>
      <input type="number" id="customerCount" placeholder="è«‹è¼¸å…¥ä¾†å®¢æ•¸" oninput="calculateAverage()">
    </div>
    <div class="calc-result" id="avgResult">è«‹è¼¸å…¥ä¾†å®¢æ•¸ä»¥è¨ˆç®—å¹³å‡æ¶ˆè²»</div>
  </div>

  <script>
    const TOTAL_AMOUNT = ${stats.totalAmount};
    function calculateAverage(){
      const count=parseInt(document.getElementById('customerCount').value)||0;
      const result=document.getElementById('avgResult');
      if(count>0){
        const avg=Math.round(TOTAL_AMOUNT/count);
        result.textContent='å¹³å‡æ¶ˆè²»ï¼š$'+avg.toLocaleString()+' / äºº';
      }else{
        result.textContent='è«‹è¼¸å…¥ä¾†å®¢æ•¸ä»¥è¨ˆç®—å¹³å‡æ¶ˆè²»';
      }
    }
  <\/script>
</body>
</html>`;

  // é–‹å•Ÿæ–°è¦–çª—
  const win=window.open('','ä¸‹åˆèŒ¶ç¸½çµ','width=600,height=800');
  win.document.write(html);
  win.document.close();
}

async function deleteRecord(idx){
  if(!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„ï¼Ÿ')) return;
  try{
    showLoading();
    const body = new URLSearchParams();
    body.append('action','deleteRecord');
    body.append('index', String(idx));
    await fetch(SCRIPT_URL,{method:'POST',body:body});
    await loadRecords();
    hideLoading();
  }catch(e){
    hideLoading();
    alert('åˆªé™¤å¤±æ•—ï¼š'+e.message);
  }
}

async function clearTodayRecords(){
  if(!confirm('âš ï¸ ç¢ºå®šè¦æ¸…ç©ºä»Šå¤©æ‰€æœ‰çš„çµå¸³è¨˜éŒ„å—ï¼Ÿ\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) return;
  if(!confirm('âš ï¸ å†æ¬¡ç¢ºèªï¼šçœŸçš„è¦åˆªé™¤ä»Šå¤©å…¨éƒ¨ '+window.S.h.length+' ç­†è¨˜éŒ„å—ï¼Ÿ')) return;
  try{
    showLoading();
    const body = new URLSearchParams();
    body.append('action','clearTodayRecords');
    const response = await fetch(SCRIPT_URL,{method:'POST',body:body});
    const result = await response.json();
    await loadRecords();
    hideLoading();
    if(result.success){
      alert('âœ… å·²æ¸…ç©ºä»Šæ—¥è¨˜éŒ„');
    }else{
      alert('âŒ æ¸…ç©ºå¤±æ•—ï¼š'+result.message);
    }
  }catch(e){
    hideLoading();
    alert('æ¸…ç©ºå¤±æ•—ï¼š'+e.message);
  }
}

function Q(i){return window.S.cart[i]||0}
function SQ(i,v){v=Math.max(0,parseInt(v)||0);v>0?window.S.cart[i]=v:delete window.S.cart[i];saveState();R()}
function A(i,d){SQ(i,Q(i)+d)}
function getDis(){const s=window.S;if(s.teaGiftDiscount)return 0.95;if(s.m==='blue')return s.bd?0.9:0.95;if(s.m==='white')return s.bd?0.9:1;return 1}
function getBoxDis(){const s=window.S;const d=window.DATA.christmas;let bq=0;d.box.forEach(p=>bq+=Q(p.id));let discount=1;if(bq>=101)discount=0.85;else if(bq>=50)discount=0.86;else if(bq>=2)discount=(s.m==='blue'||s.m==='white')?0.89:0.95;else if(bq===1){if(s.m==='blue')discount=s.bd?0.9:0.95;else if(s.m==='white')discount=s.bd?0.9:1}if(s.teaGiftDiscount){return Math.min(discount,0.95)}return discount}

// å…¨åŸŸè®Šæ•¸å­˜å„²çµå¸³æ•¸æ“š
window.checkoutData = {productItems:[], teaItems:[], total:0};

function CO(){
  const {productItems, teaItems, total} = window.checkoutData;
  const s = window.S;
// ğŸ”¥ å¼·åˆ¶å¾ç•«é¢æŠ“å–æœ€æ–°å‚™è¨»ï¼ˆå³ä½¿ window.S.notes æ²’æ›´æ–°ä¹Ÿèƒ½æŠ“åˆ°ï¼‰
const notesInput = document.getElementById('notesInput');
if (notesInput) {
  s.notes = notesInput.value;
}

  // ä½¿ç”¨æ‰‹å‹•é‡‘é¡æˆ–è¨ˆç®—é‡‘é¡
  const finalTotal = s.manualAmount > 0 ? s.manualAmount : total;

  console.log('=== çµå¸³è³‡æ–™ ===');
  console.log('å•†å“é …ç›®:', productItems);
  console.log('ä¸‹åˆèŒ¶é …ç›®:', teaItems);
  console.log('è¨ˆç®—é‡‘é¡:', total);
  console.log('æ‰‹å‹•é‡‘é¡:', s.manualAmount);
  console.log('æœ€çµ‚é‡‘é¡:', finalTotal);
  console.log('å‚™è¨» (s.notes):', s.notes);
  console.log('å‚™è¨»è¼¸å…¥æ¡†å€¼ (notesInput.value):', notesInput ? notesInput.value : 'notesInput ä¸å­˜åœ¨');

  const allItems=[...productItems,...teaItems];
  if(allItems.length===0){alert('è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼');return}

  // æ·»åŠ æœƒå“¡è³‡è¨Šåˆ°å•†å“åˆ—è¡¨é–‹é ­
  const finalProductItems = [...productItems];
  let memberInfo = '';
  if(s.m==='blue'){
    memberInfo = 'ğŸ’ è—é‘½æœƒå“¡' + (s.bd?' (ç”Ÿæ—¥æœˆ9æŠ˜)':' (95æŠ˜)');
  }else if(s.m==='white'){
    memberInfo = 'â¬œ ç™½é‘½æœƒå“¡' + (s.bd?' (ç”Ÿæ—¥æœˆ9æŠ˜)':' (åŸåƒ¹)');
  }else if(s.xm){
    memberInfo = 'ğŸ‘‘ è–èª•æœƒå“¡å„ªæƒ ';
  }

  if(memberInfo){
    finalProductItems.unshift(memberInfo);  // åŠ åˆ°æœ€å‰é¢
  }

  const now=new Date();
  const ts=formatDateTime(now);
  const record={time:ts,productItems:finalProductItems,teaItems:teaItems,total:finalTotal,notes:s.notes||'',dragon:false};

  console.log('æº–å‚™å„²å­˜çš„è¨˜éŒ„:', record);
  saveRecord(record);

  // æ§‹å»ºçµå¸³æˆåŠŸè¨Šæ¯
  let msg = 'âœ… çµå¸³æˆåŠŸï¼\n\n';
  msg += 'â° æ™‚é–“ï¼š' + formatTime(now) + '\n';
  msg += 'ğŸ“¦ å•†å“ï¼š' + allItems.length + ' é …\n';
  msg += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';

  const {originalTotal:origTotal, discount:disc} = window.checkoutData;
  if(disc > 0){
    msg += 'åŸåƒ¹ï¼š$' + origTotal.toLocaleString() + '\n';
    msg += 'æŠ˜æ‰£ï¼š-$' + disc.toLocaleString();
    const discountPercent = Math.round((disc / origTotal) * 100);
    msg += ' (' + discountPercent + '%)\n';
    msg += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
  }

  if(finalTotal===0){
    msg += 'ğŸ’° æ‡‰ä»˜ï¼š$0\nï¼ˆä½¿ç”¨åˆ¸å…¨é¡æŠ˜æŠµï¼‰';
  }else{
    msg += 'ğŸ’° æ‡‰ä»˜ï¼š$' + finalTotal.toLocaleString();
    if(s.manualAmount > 0){
      msg += '\nï¼ˆæ‰‹å‹•èª¿æ•´é‡‘é¡ï¼‰';
    }
  }

  if(s.notes){
    msg += '\nğŸ“ å‚™è¨»ï¼š' + s.notes;
  }

  alert(msg);
  window.S.cart={};window.S.tv=0;window.S.tb=0;window.S.td=1;window.S.xm=false;window.S.m='normal';window.S.bd=false;window.S.manualAmount=0;window.S.notes='';window.S.giftProduct='';window.S.giftQty=0;window.S.tab='records';saveState();R();
}

function R(){
  const s=window.S,d=window.DATA;
  const Q2=(i,dis)=>'<div class="qty-ctrl"><button class="minus" onclick="A(\''+i+'\',-1)">-</button><input type="number" value="'+Q(i)+'" onchange="SQ(\''+i+'\',this.value)"><button class="plus" onclick="A(\''+i+'\',1)"'+(dis?' style="background:#666"':'')+'>+</button></div>';

  let h='<div class="tabs">'+Object.keys(d).map(k=>'<button class="'+(s.tab===k?'active':'')+'" onclick="window.S.tab=\''+k+'\';saveState();R()">'+d[k].name+'</button>').join('')+'</div>';

  if(s.tab==='records'){
    const td=new Date().toLocaleDateString('zh-TW');
    const tt=s.h.reduce((sum,r)=>sum+r.total,0);
    const dragonTotal=s.h.filter(r=>r.dragon).reduce((sum,r)=>sum+r.total,0);
    const dragonCount=s.h.filter(r=>r.dragon).length;
    h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">';
    h+='<div class="discount-info" style="margin:0">ğŸ“…'+td+' | å…±'+s.h.length+'ç­† | ç‡Ÿæ¥­é¡$'+tt.toLocaleString();
    if(dragonCount>0)h+=' | ç¥¥é¾:'+dragonCount+'ç­†/$'+dragonTotal.toLocaleString();
    h+='</div>';
    if(s.h.length>0){
      h+='<button onclick="clearTodayRecords()" style="background:#dc2626;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:bold">ğŸ—‘ï¸ æ¸…ç©ºä»Šæ—¥è¨˜éŒ„</button>';
    }
    h+='</div><div style="background:#1f2937;border-radius:8px;padding:10px;margin-bottom:10px;max-height:70vh;overflow-y:auto">';
    if(s.h.length===0){
      h+='<div style="color:#666;text-align:center;padding:20px">ä»Šå¤©é‚„æ²’æœ‰çµå¸³è¨˜éŒ„</div>';
    }else{
      s.h.forEach((r,i)=>{
        const n=i+1;
        const hasProducts=r.productItems&&r.productItems.length>0;
        const hasTea=r.teaItems&&r.teaItems.length>0;
        h+='<div style="background:#374151;border-radius:6px;padding:10px;margin-bottom:8px'+(r.dragon?';border:2px solid #fbbf24':'')+'">';
        h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid #4b5563">';
        h+='<div style="display:flex;align-items:center;gap:8px">';
        h+='<b style="color:#fde047;font-size:17px">#'+n+'</b>';
        h+='<span style="color:#9ca3af;font-size:14px">'+r.time+'</span>';
        h+='<label style="display:flex;align-items:center;gap:4px;font-size:14px;color:#fde047;cursor:pointer;margin-left:8px">';
        h+='<input type="checkbox"'+(r.dragon?' checked':'')+' onchange="toggleDragon('+i+')" style="cursor:pointer">ç¥¥é¾</label>';
        h+='</div><div style="display:flex;align-items:center;gap:8px">';
        h+='<b style="color:#4ade80;font-size:20px">$'+r.total.toLocaleString()+'</b>';
        h+='<button onclick="deleteRecord('+i+')" style="background:#79635b;border:none;color:#fff;padding:6px 10px;border-radius:4px;cursor:pointer;font-size:18px">ğŸ—‘ï¸</button>';
        h+='</div></div>';
        h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:14px">';
        h+='<div style="background:#1f2937;padding:8px;border-radius:4px">';
        h+='<div style="color:#60a5fa;font-weight:bold;margin-bottom:4px;font-size:15px">ğŸª å•†å“</div>';
        if(hasProducts){
          let productSubtotal=0;
          r.productItems.forEach(it=>{
            h+='<div style="color:#e5e7eb;margin:2px 0;padding-left:4px;font-size:13px">â€¢ '+it+'</div>';
            // è·³éæœƒå“¡è³‡è¨Šæ¨™è¨˜ï¼ˆä¸å«åƒ¹æ ¼ï¼‰
            if(it.includes('ğŸ’')||it.includes('â¬œ')||it.includes('ğŸ‘‘')){
              return; // è·³éæœƒå“¡è³‡è¨Š
            }
            // æå–åƒ¹æ ¼ï¼ˆæ ¼å¼: "å•†å“å xæ•¸é‡ $åƒ¹æ ¼"ï¼‰
            const priceMatch=it.match(/\$[\d,]+/);
            if(priceMatch){
              const price=parseInt(priceMatch[0].replace(/[$,]/g,''));
              productSubtotal+=price;
            }
          });
          h+='<div style="margin-top:6px;padding-top:6px;border-top:1px solid #4b5563;color:#60a5fa;font-weight:bold;font-size:14px">å°è¨ˆ: $'+productSubtotal.toLocaleString()+'</div>';
        }else{
          h+='<div style="color:#666;font-style:italic;font-size:13px">ç„¡</div>';
        }
        h+='</div>';
        h+='<div style="background:#1f2937;padding:8px;border-radius:4px">';
        h+='<div style="color:#fbbf24;font-weight:bold;margin-bottom:4px;font-size:15px">â˜• ä¸‹åˆèŒ¶</div>';
        if(hasTea){
          let teaSubtotal=0;
          r.teaItems.forEach(it=>{
            h+='<div style="color:#e5e7eb;margin:2px 0;padding-left:4px;font-size:13px">â€¢ '+it+'</div>';
            // è·³éå…Œæ›åˆ¸ï¼ˆè²´è³“åˆ¸å’Œç”Ÿæ—¥ç¦®ä¸è¨ˆå…¥å°è¨ˆï¼‰
            if(it.includes('ğŸ‘‘è²´è³“åˆ¸')||it.includes('ğŸ‚ç”Ÿæ—¥ç¦®')){
              return; // è·³éæ­¤é …ç›®
            }
            // æå–åƒ¹æ ¼ï¼ˆæ ¼å¼: "å•†å“å xæ•¸é‡ $åƒ¹æ ¼"ï¼‰
            const priceMatch=it.match(/\$[\d,]+/);
            if(priceMatch){
              const price=parseInt(priceMatch[0].replace(/[$,]/g,''));
              teaSubtotal+=price;
            }
          });
          h+='<div style="margin-top:6px;padding-top:6px;border-top:1px solid #4b5563;color:#fbbf24;font-weight:bold;font-size:14px">å°è¨ˆ: $'+teaSubtotal.toLocaleString()+'</div>';
        }else{
          h+='<div style="color:#666;font-style:italic;font-size:13px">ç„¡</div>';
        }
        h+='</div></div>';
        // é¡¯ç¤ºå‚™è¨»ï¼ˆç¸½æ˜¯é¡¯ç¤ºï¼Œä¸è«–æ˜¯å¦æœ‰å…§å®¹ï¼‰
        h+='<div style="margin-top:8px;padding:8px;background:#1f2937;border-radius:4px;border-left:3px solid #fbbf24">';
        h+='<div style="color:#fbbf24;font-weight:bold;font-size:13px;margin-bottom:4px">ğŸ“ å‚™è¨»</div>';
        h+='<div style="color:#e5e7eb;font-size:13px">'+(r.notes?r.notes:'<span style="color:#666;font-style:italic">ç„¡</span>')+'</div>';
        h+='</div>';
        h+='</div>';
      });
    }
    h+='</div>';
    // ä¸‹åˆèŒ¶ç¸½çµæŒ‰éˆ•
    if(s.h.length>0){
      h+='<button onclick="openTeaSummary()" style="width:100%;background:#f59e0b;border:none;color:#fff;padding:14px;border-radius:6px;font-size:18px;font-weight:bold;cursor:pointer;margin-top:10px">ğŸ“Š ä¸‹åˆèŒ¶ç¸½çµ</button>';
    }
  }else if(s.tab==='christmas'){
    const dd=d.christmas;
    h+='<div class="member-section"><div class="member-row"><button class="'+(s.m==='normal'?'active':'')+'" onclick="window.S.m=\'normal\';saveState();R()">ä¸€èˆ¬</button><button class="'+(s.m==='blue'?'active':'')+'" onclick="window.S.m=\'blue\';saveState();R()">ğŸ’è—é‘½</button><button class="'+(s.m==='white'?'active':'')+'" onclick="window.S.m=\'white\';saveState();R()">â¬œç™½é‘½</button><label><input type="checkbox"'+(s.bd?' checked':'')+' onchange="window.S.bd=this.checked;saveState();R()">ç”Ÿæ—¥æœˆ</label></div></div>';
    h+='<div class="discount-info">'+(s.m==='blue'?'ğŸ’è—é‘½:'+(s.bd?'ç”Ÿæ—¥æœˆ9æŠ˜':'95æŠ˜'):s.m==='white'?'â¬œç™½é‘½:'+(s.bd?'ç”Ÿæ—¥æœˆ9æŠ˜':'åŸåƒ¹'):'ä¸€èˆ¬:åŸåƒ¹')+' | ğŸ“¦ç›’è£:2ç›’'+(s.m==='blue'||s.m==='white'?'89':'95')+'æŠ˜/50ç›’86æŠ˜/101ç›’85æŠ˜ | ğŸè¢‹è£:3è¢‹ä»¥ä¸Šæ¯è¢‹$400</div>';
    h+='<div class="section"><h2>è–èª•é›™æ‹¼</h2>'+dd.combo.map(p=>'<div class="product-row combo"><div class="info"><div class="name">'+p.name+'</div><div class="price">'+(p.orig?'<s style="color:#999">$'+p.orig.toLocaleString()+'</s> â†’ ':'')+' $'+p.price.toLocaleString()+'</div></div>'+Q2(p.id)+'</div>').join('')+'</div>';
    h+='<div class="section"><h2>å·§å…‹åŠ›ç‰¹æƒ </h2>'+dd.special.map(p=>'<div class="product-row special"><div class="info"><div class="name">'+p.name+'</div><div class="price">'+(p.orig?'<s style="color:#999">$'+p.orig.toLocaleString()+'</s> â†’ ':'')+'$'+p.price.toLocaleString()+'</div></div>'+Q2(p.id)+'</div>').join('')+'</div>';
    h+='<div class="section"><h2>è›‹æ²å„ªæƒ </h2>'+dd.bagroll.map(p=>'<div class="product-row special"><div class="info"><div class="name">'+p.name+'</div><div class="price">'+(p.orig?'<s style="color:#999">$'+p.orig.toLocaleString()+'</s> â†’ ':'')+'$'+p.price.toLocaleString()+'</div></div>'+Q2(p.id)+'</div>').join('')+'</div>';
    h+='<div class="section"><h2>è¢‹è£(ä¸‰è¢‹å„ªæƒ 1200)</h2>'+dd.bag.map(p=>'<div class="product-row bag"><div class="info"><div class="name">'+p.name+'</div><div class="price">$'+p.price.toLocaleString()+'</div></div>'+Q2(p.id)+'</div>').join('')+'</div>';
    h+='<div class="section"><h2>ç›’è£</h2>'+dd.box.map(p=>'<div class="product-row brown5"><div class="info"><div class="name">'+p.name+'</div><div class="price">$'+p.price.toLocaleString()+'</div></div>'+Q2(p.id)+'</div>').join('')+'</div>';
  }else if(s.tab==='giftbox'){
    const gg=d.giftbox;
    h+='<div class="member-section"><div class="member-row"><button class="'+(s.m==='normal'?'active':'')+'" onclick="window.S.m=\'normal\';saveState();R()">ä¸€èˆ¬</button><button class="'+(s.m==='blue'?'active':'')+'" onclick="window.S.m=\'blue\';saveState();R()">ğŸ’è—é‘½</button><button class="'+(s.m==='white'?'active':'')+'" onclick="window.S.m=\'white\';saveState();R()">â¬œç™½é‘½</button><label><input type="checkbox"'+(s.bd?' checked':'')+' onchange="window.S.bd=this.checked;saveState();R()">ç”Ÿæ—¥æœˆ</label></div></div>';
    h+='<div class="discount-info">'+(s.m==='blue'?'ğŸ’è—é‘½:'+(s.bd?'ç”Ÿæ—¥æœˆ9æŠ˜':'95æŠ˜'):s.m==='white'?'â¬œç™½é‘½:'+(s.bd?'ç”Ÿæ—¥æœˆ9æŠ˜':'åŸåƒ¹'):'ä¸€èˆ¬:åŸåƒ¹')+'</div>';
    h+='<div class="section"><h2>ğŸä¸€èˆ¬ç¦®ç›’</h2>'+gg.general.map(p=>'<div class="product-row brown2"><div class="info"><div class="name">'+p.name+'</div><div class="price">$'+p.price.toLocaleString()+'</div></div>'+Q2(p.id)+'</div>').join('')+'</div>';
    h+='<div class="section"><h2>ğŸ€é›™æ‹¼ç¦®ç›’</h2>'+gg.double.map(p=>'<div class="product-row brown6"><div class="info"><div class="name">'+p.name+'</div><div class="price">$'+p.price.toLocaleString()+'</div></div>'+Q2(p.id)+'</div>').join('')+'</div>';
  }else if(s.tab==='tea'){
    const tt=d.tea;
    h+='<div class="discount-info">â˜•1è›‹ç³•+1é£²æ–™=1å¥—,é£²æ–™-$30 | ä¸‹åˆèŒ¶ä¸é©ç”¨æœƒå“¡æŠ˜æ‰£</div>';
    h+='<div style="background:#374151;padding:8px;border-radius:6px;margin-bottom:8px;font-size:12px"><b style="display:block;margin-bottom:6px;color:#fde047">æ•´å–®æŠ˜æ‰£:</b>';
    h+='<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">'+[1,0.95,0.9,0.85,0.7].map(v=>'<button style="padding:4px 12px;border:none;border-radius:4px;cursor:pointer;'+(s.td===v?'background:#f59e0b;color:#fff;font-weight:bold':'background:#1f2937;color:#fff')+'" onclick="window.S.td='+v+';saveState();R()">'+(v===1?'ç„¡':Math.round(v*100)+'æŠ˜')+'</button>').join('')+'</div>';
    h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><label style="min-width:80px">ğŸ‘‘è²´è³“åˆ¸:</label><div class="qty-ctrl"><button class="minus" onclick="window.S.tv=Math.max(0,window.S.tv-1);saveState();R()">-</button><input type="number" value="'+s.tv+'" onchange="window.S.tv=Math.max(0,+this.value);saveState();R()" style="width:50px"><button class="plus" onclick="window.S.tv++;saveState();R()">+</button></div><span>å¥—</span></div>';
    h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><label style="min-width:80px">ğŸ‚ç”Ÿæ—¥ç¦®:</label><div class="qty-ctrl"><button class="minus" onclick="window.S.tb=Math.max(0,window.S.tb-1);saveState();R()">-</button><input type="number" value="'+s.tb+'" onchange="window.S.tb=Math.max(0,+this.value);saveState();R()" style="width:50px"><button class="plus" onclick="window.S.tb++;saveState();R()">+</button></div><span>å¥—</span></div>';
    h+='<div style="border-top:1px solid #4b5563;padding-top:8px;margin-top:8px"><b style="display:block;margin-bottom:6px;color:#fde047">ğŸ è´ˆé€å•†å“:</b>';
    // æª¢æ¸¬æ˜¯å¦è³¼è²·äº†è–èª•å„ªæƒ çµ„åˆ
    const hasXmasCombo=Q('XMAS-1')>0||Q('XMAS-2')>0||Q('YCN-A-2')>0||Q('YCG-AXM-5')>0||Q('YCG-AXM-3')>0;
    if(hasXmasCombo){
      h+='<div style="background:#2d5016;padding:8px;border-radius:4px;margin-bottom:8px;border-left:3px solid #4ade80"><div style="color:#4ade80;font-weight:bold;font-size:13px;margin-bottom:4px">ğŸ„ è–èª•å„ªæƒ çµ„åˆå°ˆå±¬</div><div style="color:#e5e7eb;font-size:12px">å‡¡è³¼è²·è–èª•é™å®šç¦®ç›’å„ªæƒ çµ„ï¼Œè´ˆé€é£²æ–™ä¹™æ¯ï¼</div></div>';
    }
    h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><label style="min-width:80px">å•†å“:</label><select onchange="window.S.giftProduct=this.value;saveState();R()" style="flex:1;padding:6px;border-radius:4px;border:1px solid #4b5563;background:#374151;color:#fff"><option value="">è«‹é¸æ“‡å•†å“</option>'+tt.cake.concat(tt.drink,tt.roll).map(p=>'<option value="'+p.name+'" '+(s.giftProduct===p.name?'selected':'')+'>'+p.name+'</option>').join('')+'</select></div>';
    h+='<div style="display:flex;align-items:center;gap:8px"><label style="min-width:80px">æ•¸é‡:</label><div class="qty-ctrl"><button class="minus" onclick="window.S.giftQty=Math.max(0,window.S.giftQty-1);saveState();R()">-</button><input type="number" value="'+(s.giftQty||0)+'" onchange="window.S.giftQty=Math.max(0,+this.value);saveState();R()" style="width:50px"><button class="plus" onclick="window.S.giftQty=(window.S.giftQty||0)+1;saveState();R()">+</button></div><span>ä»½</span></div></div></div>';
    h+='<div class="section"><h2>è›‹ç³•</h2>'+tt.cake.map(p=>'<div class="product-row cake"><div class="info"><div class="name">'+p.name+'</div><div class="price">$'+p.price.toLocaleString()+'</div></div>'+Q2(p.id)+'</div>').join('')+'</div>';
    h+='<div class="section"><h2>é£²å“</h2>'+tt.drink.map(p=>'<div class="product-row drink"><div class="info"><div class="name">'+p.name+'</div><div class="price">$'+p.price.toLocaleString()+'</div></div>'+Q2(p.id)+'</div>').join('')+'</div>';
    h+='<div class="section"><h2>ä¸€æ•´æ¢ç”Ÿä¹³æ² <span style="font-size:13px;color:#fdba74">(ä¸å¯é…å¥—é¤ï¼Œä¸é©ç”¨åˆ¸ï¼Œå¯æ‰“æŠ˜)</span></h2>'+tt.roll.map(p=>'<div class="product-row" style="background:#4a3f35"><div class="info"><div class="name">'+p.name+'</div><div class="price">$'+p.price.toLocaleString()+'</div></div>'+Q2(p.id)+'</div>').join('')+'</div>';
  }else if(s.tab==='cigare'){
    const cc=d.cigare;
    h+='<div class="member-section"><div class="member-row"><button class="'+(s.m==='normal'?'active':'')+'" onclick="window.S.m=\'normal\';saveState();R()">ä¸€èˆ¬</button><button class="'+(s.m==='blue'?'active':'')+'" onclick="window.S.m=\'blue\';saveState();R()">ğŸ’è—é‘½</button><button class="'+(s.m==='white'?'active':'')+'" onclick="window.S.m=\'white\';saveState();R()">â¬œç™½é‘½</button><label><input type="checkbox"'+(s.bd?' checked':'')+' onchange="window.S.bd=this.checked;saveState();R()">ç”Ÿæ—¥æœˆ</label></div></div>';
    h+='<div class="discount-info">'+(s.m==='blue'?'ğŸ’è—é‘½:'+(s.bd?'ç”Ÿæ—¥æœˆ9æŠ˜':'95æŠ˜'):s.m==='white'?'â¬œç™½é‘½:'+(s.bd?'ç”Ÿæ—¥æœˆ9æŠ˜':'åŸåƒ¹'):'ä¸€èˆ¬:åŸåƒ¹')+'</div>';
    h+='<div class="section"><h2>åŸå‘³ 10/14/16å…¥</h2>'+cc.original_small.map(p=>'<div class="product-row brown1"><div class="info"><div class="name">'+p.name+'</div><div class="price">$'+p.price.toLocaleString()+'</div></div>'+Q2(p.id)+'</div>').join('')+'</div>';
    h+='<div class="section"><h2>åŸå‘³ 20å…¥</h2>'+cc.original_20.map(p=>'<div class="product-row brown2"><div class="info"><div class="name">'+p.name+'</div><div class="price">$'+p.price.toLocaleString()+'</div></div>'+Q2(p.id)+'</div>').join('')+'</div>';
    h+='<div class="section"><h2>åŸå‘³ 30/48å…¥</h2>'+cc.original_large.map(p=>'<div class="product-row brown3"><div class="info"><div class="name">'+p.name+'</div><div class="price">$'+p.price.toLocaleString()+'</div></div>'+Q2(p.id)+'</div>').join('')+'</div>';
    h+='<div class="section"><h2>å·§å…‹åŠ›</h2>'+cc.chocolate.map(p=>'<div class="product-row brown4"><div class="info"><div class="name">'+p.name+'</div><div class="price">$'+p.price.toLocaleString()+'</div></div>'+Q2(p.id)+'</div>').join('')+'</div>';
  }else{
    const cc=d[s.tab];
    const st=s.tab==='wood'?'wood':s.tab==='baton'?'cookie':'';
    h+='<div class="member-section"><div class="member-row"><button class="'+(s.m==='normal'?'active':'')+'" onclick="window.S.m=\'normal\';saveState();R()">ä¸€èˆ¬</button><button class="'+(s.m==='blue'?'active':'')+'" onclick="window.S.m=\'blue\';saveState();R()">ğŸ’è—é‘½</button><button class="'+(s.m==='white'?'active':'')+'" onclick="window.S.m=\'white\';saveState();R()">â¬œç™½é‘½</button><label><input type="checkbox"'+(s.bd?' checked':'')+' onchange="window.S.bd=this.checked;saveState();R()">ç”Ÿæ—¥æœˆ</label></div></div>';
    h+='<div class="discount-info">'+(s.m==='blue'?'ğŸ’è—é‘½:'+(s.bd?'ç”Ÿæ—¥æœˆ9æŠ˜':'95æŠ˜'):s.m==='white'?'â¬œç™½é‘½:'+(s.bd?'ç”Ÿæ—¥æœˆ9æŠ˜':'åŸåƒ¹'):'ä¸€èˆ¬:åŸåƒ¹')+'</div>';
    h+='<div class="section"><h2>'+cc.name+'</h2>'+cc.items.map(p=>'<div class="product-row '+st+'"><div class="info"><div class="name">'+p.name+'</div><div class="price">$'+p.price.toLocaleString()+'</div></div>'+Q2(p.id)+'</div>').join('')+'</div>';
  }

  // è³¼ç‰©è»Šå€å¡Šï¼ˆè¨˜éŒ„é ä¸é¡¯ç¤ºï¼‰
  if(s.tab!=='records'){
    let gt=0;const boxDis=getBoxDis();const genDis=getDis();let productItems=[],teaItems=[];
    h+='<div class="cart"><h3>ğŸ›’ è³¼ç‰©è»Š</h3>';

  if(d.christmas.combo.some(p=>Q(p.id)>0)){
    h+='<div class="cat-title">è–èª•é›™æ‹¼ <span style="font-size:13px;color:#fdba74">(ç‰¹æƒ åƒ¹ï¼Œä¸é©ç”¨æœƒå“¡æŠ˜æ‰£)</span></div>';
    d.christmas.combo.forEach(p=>{const q=Q(p.id);if(q>0){const t=p.price*q;h+='<div class="cart-item"><span class="item-name">'+p.name+' x'+q+'</span><span class="price-final">$'+t.toLocaleString()+'</span></div>';gt+=t;productItems.push(p.name+' x'+q+' $'+t.toLocaleString())}});
  }

  if(Q('CHOCO18')>0 || Q('CHOCO8')>0){
    h+='<div class="cat-title">å·§å…‹åŠ›ç‰¹æƒ  <span style="font-size:13px;color:#fdba74">(ç‰¹æƒ åƒ¹ï¼Œä¸é©ç”¨æœƒå“¡æŠ˜æ‰£)</span></div>';
    if(Q('CHOCO18')>0){
      const p=d.christmas.special[0];const q=Q('CHOCO18');const f=p.price*q;
      h+='<div class="cart-item"><span class="item-name">'+p.name+' x'+q+'</span><span class="price-final">$'+f.toLocaleString()+'</span></div>';
      gt+=f;productItems.push(p.name+' x'+q+' $'+f.toLocaleString());
    }
    if(Q('CHOCO8')>0){
      const q=Q('CHOCO8');const t=300*q;
      h+='<div class="cart-item"><span class="item-name">8å…¥å·§å…‹åŠ›é›ªèŒ„ x'+q+'</span><span class="price-final">$'+t.toLocaleString()+'</span></div>';
      gt+=t;productItems.push('8å…¥å·§å…‹åŠ›é›ªèŒ„ x'+q+' $'+t.toLocaleString());
    }
  }

  if(Q('YCG-D-2')>0 || Q('YCG-AXM-5')>0){
    h+='<div class="cat-title">è›‹æ²å„ªæƒ  <span style="font-size:13px;color:#fdba74">(ç‰¹æƒ åƒ¹ï¼Œä¸é©ç”¨æœƒå“¡æŠ˜æ‰£)</span></div>';
    d.christmas.bagroll.forEach(p=>{
      const q=Q(p.id);
      if(q>0){
        const f=p.price*q;
        h+='<div class="cart-item"><span class="item-name">'+p.name+' x'+q+'</span><span class="price-final">$'+f.toLocaleString()+'</span></div>';
        gt+=f;productItems.push(p.name+' x'+q+' $'+f.toLocaleString());
      }
    });
  }

  let bagCnt=0,bagOrig=0;
  d.christmas.bag.forEach(p=>{const q=Q(p.id);if(q>0){bagCnt+=q;bagOrig+=p.price*q}});
  if(bagCnt>0){
    let bagDiscount=1;
    if(bagCnt>=3){
      // ä¸‰è¢‹ä»¥ä¸Šäº«å—æ¯è¢‹400å„ªæƒ ï¼Œä¸å åŠ å…¶ä»–æŠ˜æ‰£
      bagDiscount=Math.min(1,(bagCnt*400)/bagOrig);
    }else{
      // å°‘æ–¼3è¢‹æ‰èƒ½äº«å—ä¸‹åˆèŒ¶åŠ è³¼95æŠ˜
      if(s.teaGiftDiscount)bagDiscount=0.95;
    }
    const bagFinal=Math.round(bagOrig*bagDiscount);
    const isMultiBag=bagCnt>=3&&(bagCnt*400)<bagOrig;
    const isTeaDiscount=!isMultiBag&&s.teaGiftDiscount&&bagDiscount===0.95;
    let bagLabel='è¢‹è£(ä¸‰è¢‹å„ªæƒ 1200)';
    if(isTeaDiscount)bagLabel+=' (ä¸‹åˆèŒ¶åŠ è³¼95æŠ˜)';
    else if(isMultiBag)bagLabel+=' (æ¯è¢‹$400) <span style="font-size:13px;color:#fdba74">(å„ªæƒ åƒ¹)</span>';
    h+='<div class="cat-title">'+bagLabel+'</div>';
    d.christmas.bag.forEach(p=>{
      const q=Q(p.id);
      if(q>0){
        const orig=p.price*q;
        const f=Math.round(orig*bagDiscount);
        const unitPriceOrig=p.price;
        const unitPriceFinal=Math.round(p.price*bagDiscount);
        const qtyLabel='<span style="color:#fbbf24"> x'+q+'</span>';
        let priceDisplay='';
        if(bagDiscount<1){
          const discountPercent=Math.round(bagDiscount*100);
          priceDisplay='<span class="item-price"><span class="price-orig">åŸåƒ¹$'+unitPriceOrig+'/è¢‹</span><span style="color:#fdba74;font-size:14px">'+discountPercent+'æŠ˜</span><span class="price-final">$'+unitPriceFinal+'/è¢‹'+qtyLabel+'</span><span style="color:#4ade80;font-weight:bold;margin-left:8px">ç¸½é¡$'+f.toLocaleString()+'</span></span>';
        }else{
          priceDisplay='<span class="price-final">$'+unitPriceFinal+'/è¢‹'+qtyLabel+'<span style="color:#4ade80;font-weight:bold;margin-left:8px">ç¸½é¡$'+f.toLocaleString()+'</span></span>';
        }
        h+='<div class="cart-item"><span class="item-name">'+p.name+qtyLabel+'</span>'+priceDisplay+'</div>';
        productItems.push(p.name+' x'+q+' $'+f.toLocaleString());
      }
    });
    gt+=bagFinal;
  }

  let boxCnt=0,boxOrig=0;
  d.christmas.box.forEach(p=>{const q=Q(p.id);if(q>0){boxCnt+=q;boxOrig+=p.price*q}});
  if(boxCnt>0){
    const boxFinal=Math.round(boxOrig*boxDis);
    h+='<div class="cat-title">è–èª•ç›’è£'+(boxDis<1?' ('+Math.round(boxDis*100)+'æŠ˜)':'')+'</div>';
    d.christmas.box.forEach(p=>{
      const q=Q(p.id);
      if(q>0){
        const orig=p.price*q;
        const f=Math.round(orig*boxDis);
        const unitPriceOrig=p.price;
        const unitPriceFinal=Math.round(p.price*boxDis);
        const qtyLabel='<span style="color:#fbbf24"> x'+q+'</span>';
        let priceDisplay='';
        if(boxDis<1){
          const discountPercent=Math.round(boxDis*100);
          priceDisplay='<span class="item-price"><span class="price-orig">åŸåƒ¹$'+unitPriceOrig+'/ç›’</span><span style="color:#fdba74;font-size:14px">'+discountPercent+'æŠ˜</span><span class="price-final">$'+unitPriceFinal+'/ç›’'+qtyLabel+'</span><span style="color:#4ade80;font-weight:bold;margin-left:8px">ç¸½é¡$'+f.toLocaleString()+'</span></span>';
        }else{
          priceDisplay='<span class="price-final">$'+unitPriceFinal+'/ç›’'+qtyLabel+'<span style="color:#4ade80;font-weight:bold;margin-left:8px">ç¸½é¡$'+f.toLocaleString()+'</span></span>';
        }
        h+='<div class="cart-item"><span class="item-name">'+p.name+qtyLabel+'</span>'+priceDisplay+'</div>';
        productItems.push(p.name+' x'+q+' $'+f.toLocaleString());
      }
    });
    gt+=boxFinal;
  }

  // ä¸€èˆ¬å•†å“ï¼ˆç¦®ç›’ã€è›‹æ²ã€ç§‹å†¬ã€é¤…ä¹¾æ£’ã€æœ¨ç›’ï¼‰
  let generalTotal=0;const generalItems=[];
  [{i:[...d.giftbox.general,...d.giftbox.double]},{i:[...d.cigare.original_small,...d.cigare.original_20,...d.cigare.original_large,...d.cigare.chocolate]},{i:d.autumn.items},{i:d.baton.items},{i:d.wood.items}].forEach(c=>{
    c.i.forEach(p=>{const q=Q(p.id);if(q>0){const orig=p.price*q;const f=Math.round(orig*genDis);generalTotal+=f;generalItems.push({p:p,q:q,orig:orig,f:f})}});
  });

  if(generalItems.length>0){
    // ç”¢ç”Ÿæ¨™é¡Œ
    let generalTitle='ä¸€èˆ¬å•†å“';
    if(genDis<1){
      // æœ‰æœƒå“¡æŠ˜æ‰£ï¼Œä½†æª¢æŸ¥æ˜¯å¦æœ‰æ›´å„ªæƒ çš„è–èª•æŠ˜æ‰£
      const hasLowerDiscount=boxDis<genDis;
      if(hasLowerDiscount){
        // æœ‰æ›´å„ªæƒ çš„æŠ˜æ‰£ï¼Œåªé¡¯ç¤ºæœƒå“¡èº«ä»½ï¼Œä¸é¡¯ç¤ºæŠ˜æ‰£ç™¾åˆ†æ¯”
        if(s.m==='blue')generalTitle+=' (ğŸ’è—é‘½æœƒå“¡)';
        else if(s.m==='white'&&s.bd)generalTitle+=' (â¬œç™½é‘½æœƒå“¡)';
      }else{
        // æ²’æœ‰æ›´å„ªæƒ çš„æŠ˜æ‰£ï¼Œæ­£å¸¸é¡¯ç¤ºæœƒå“¡æŠ˜æ‰£
        if(s.m==='blue')generalTitle+=s.bd?' (è—é‘½ç”Ÿæ—¥æœˆ9æŠ˜)':' (è—é‘½95æŠ˜)';
        else if(s.m==='white'&&s.bd)generalTitle+=' (ç™½é‘½ç”Ÿæ—¥æœˆ9æŠ˜)';
      }
    }
    h+='<div class="cat-title">'+generalTitle+'</div>';

    generalItems.forEach(it=>{
      const unitPriceOrig=it.p.price;
      const unitPriceFinal=Math.round(it.p.price*genDis);
      const qtyLabel='<span style="color:#fbbf24"> x'+it.q+'</span>';
      let priceDisplay='';
      if(genDis<1){
        const discountPercent=Math.round(genDis*100);
        priceDisplay='<span class="item-price"><span class="price-orig">åŸåƒ¹$'+unitPriceOrig+'/ç›’</span><span style="color:#fdba74;font-size:14px">'+discountPercent+'æŠ˜</span><span class="price-final">$'+unitPriceFinal+'/ç›’'+qtyLabel+'</span><span style="color:#4ade80;font-weight:bold;margin-left:8px">ç¸½é¡$'+it.f.toLocaleString()+'</span></span>';
      }else{
        priceDisplay='<span class="price-final">$'+unitPriceFinal+'/ç›’'+qtyLabel+'<span style="color:#4ade80;font-weight:bold;margin-left:8px">ç¸½é¡$'+it.f.toLocaleString()+'</span></span>';
      }
      h+='<div class="cart-item"><span class="item-name">'+it.p.name+qtyLabel+'</span>'+priceDisplay+'</div>';
      productItems.push(it.p.name+' x'+it.q+' $'+it.f.toLocaleString());
    });
    gt+=generalTotal;
  }

  // === ä¸‹åˆèŒ¶è¨ˆç®—é‚è¼¯ ===
  // æ­¥é©Ÿ1: æ”¶é›†æ‰€æœ‰è›‹ç³•ã€é£²æ–™å’Œç”Ÿä¹³æ²ï¼ˆä¿ç•™åƒ¹æ ¼è³‡è¨Šï¼‰
  let cakes=[];
  let drinks=[];
  let rolls=[];
  d.tea.cake.forEach(p=>{const q=Q(p.id);for(let i=0;i<q;i++)cakes.push({name:p.name,price:p.price})});
  d.tea.drink.forEach(p=>{const q=Q(p.id);for(let i=0;i<q;i++)drinks.push({name:p.name,price:p.price})});
  d.tea.roll.forEach(p=>{const q=Q(p.id);for(let i=0;i<q;i++)rolls.push({name:p.name,price:p.price})});

  if(cakes.length>0||drinks.length>0||rolls.length>0){
    // æŒ‰åƒ¹æ ¼æ’åºï¼ˆç”±é«˜åˆ°ä½ï¼‰
    cakes.sort((a,b)=>b.price-a.price);
    drinks.sort((a,b)=>b.price-a.price);

    // æ­¥é©Ÿ2: è²´è³“åˆ¸å’Œç”Ÿæ—¥ç¦®æŠ˜æŠµ
    let voucherSets=[];
    let voucherDeductions=0;
    const totalVouchers=s.tv+s.tb;
    for(let i=0;i<totalVouchers&&cakes.length>0&&drinks.length>0;i++){
      const cake=cakes.shift();
      const drink=drinks.shift();
      const setPrice=cake.price+drink.price-30;
      voucherSets.push({cake:cake,drink:drink,price:setPrice});
      voucherDeductions+=setPrice;
    }

    // æ­¥é©Ÿ3: é…å°å‰©é¤˜å¥—é¤
    let remainingSets=[];
    while(cakes.length>0&&drinks.length>0){
      const cake=cakes.shift();
      const drink=drinks.shift();
      remainingSets.push({cake:cake,drink:drink,price:cake.price+drink.price-30});
    }

    // æ­¥é©Ÿ4: è¨ˆç®—å°è¨ˆï¼ˆå‰©é¤˜å¥—é¤+å–®å“+ç”Ÿä¹³æ²ï¼‰
    let subtotal=0;
    remainingSets.forEach(set=>subtotal+=set.price);
    cakes.forEach(cake=>subtotal+=cake.price);
    drinks.forEach(drink=>subtotal+=drink.price);
    rolls.forEach(roll=>subtotal+=roll.price);

    // æ­¥é©Ÿ5: å¥—ç”¨æŠ˜æ‰£
    let discount=1;
    let discountLabel='';
    if(s.td<1){
      // æ•´å–®æŠ˜æ‰£å„ªå…ˆ
      discount=s.td;
      discountLabel=Math.round(s.td*100)+'æŠ˜';
    }
    // ä¸‹åˆèŒ¶åˆ†é ï¼šè—é‘½å’Œç™½é‘½æœƒå“¡ä¸ä½¿ç”¨å„ªæƒ ï¼Œéƒ½æ˜¯å¹³å¸¸åƒ¹æ ¼

    const finalTotal=Math.round(subtotal*discount);
    gt+=finalTotal;

    // é¡¯ç¤ºè³¼ç‰©è»Š
    h+='<div class="cat-title">ä¸‹åˆèŒ¶';
    if(voucherSets.length>0)h+=' (è²´è³“åˆ¸/ç”Ÿæ—¥ç¦®æŠ˜æŠµ'+voucherSets.length+'å¥—)';
    if(discountLabel)h+=' ('+discountLabel+')';
    h+='</div>';

    // é¡¯ç¤ºè²´è³“åˆ¸/ç”Ÿæ—¥ç¦®æŠ˜æŠµ
    if(voucherSets.length>0){
      let voucherIdx=0;
      voucherSets.forEach(set=>{
        voucherIdx++;
        let vLabel='';
        if(voucherIdx<=s.tv)vLabel='ğŸ‘‘è²´è³“åˆ¸';
        else vLabel='ğŸ‚ç”Ÿæ—¥ç¦®';

        h+='<div class="cart-item"><span class="item-name">'+vLabel+' ('+set.cake.name+' + '+set.drink.name+')</span><span class="price-final" style="color:#4ade80">-$'+set.price.toLocaleString()+'</span></div>';
        teaItems.push(vLabel+' ('+set.cake.name+' + '+set.drink.name+') -$'+set.price.toLocaleString());
      });
    }

    // é¡¯ç¤ºå‰©é¤˜å¥—é¤
    if(remainingSets.length>0){
      remainingSets.forEach(set=>{
        const origPrice=set.cake.price+set.drink.price;
        const origStr=origPrice.toLocaleString();
        const setStr=set.price.toLocaleString();
        h+='<div class="cart-item"><span class="item-name">â˜•å¥—é¤: '+set.cake.name+' + '+set.drink.name+'</span>';
        if(discount<1){
          const discPrice=Math.round(set.price*discount);
          const discStr=discPrice.toLocaleString();
          h+='<span class="item-price"><span class="price-orig">$'+setStr+'</span><span class="price-final">$'+discStr+'</span></span>';
        }else{
          h+='<span class="price-final">$'+setStr+'</span>';
        }
        h+='</div>';
        teaItems.push('å¥—é¤: '+set.cake.name+' + '+set.drink.name+' $'+(discount<1?Math.round(set.price*discount):set.price).toLocaleString());
      });
    }

    // é¡¯ç¤ºå‰©é¤˜å–®å“ï¼ˆè›‹ç³•ï¼‰
    if(cakes.length>0){
      cakes.forEach(cake=>{
        h+='<div class="cart-item"><span class="item-name">ğŸ° '+cake.name+'</span>';
        if(discount<1){
          const discPrice=Math.round(cake.price*discount);
          const discStr=discPrice.toLocaleString();
          const origStr=cake.price.toLocaleString();
          h+='<span class="item-price"><span class="price-orig">$'+origStr+'</span><span class="price-final">$'+discStr+'</span></span>';
        }else{
          h+='<span class="price-final">$'+cake.price.toLocaleString()+'</span>';
        }
        h+='</div>';
        teaItems.push(cake.name+' $'+(discount<1?Math.round(cake.price*discount):cake.price).toLocaleString());
      });
    }

    // é¡¯ç¤ºå‰©é¤˜å–®å“ï¼ˆé£²æ–™ï¼‰
    if(drinks.length>0){
      drinks.forEach(drink=>{
        h+='<div class="cart-item"><span class="item-name">â˜• '+drink.name+'</span>';
        if(discount<1){
          const discPrice=Math.round(drink.price*discount);
          const discStr=discPrice.toLocaleString();
          const origStr=drink.price.toLocaleString();
          h+='<span class="item-price"><span class="price-orig">$'+origStr+'</span><span class="price-final">$'+discStr+'</span></span>';
        }else{
          h+='<span class="price-final">$'+drink.price.toLocaleString()+'</span>';
        }
        h+='</div>';
        teaItems.push(drink.name+' $'+(discount<1?Math.round(drink.price*discount):drink.price).toLocaleString());
      });
    }

    // é¡¯ç¤ºç”Ÿä¹³æ²ï¼ˆä¸å¯é…å¥—é¤ï¼Œä¸é©ç”¨åˆ¸ï¼Œå¯æ‰“æŠ˜ï¼‰
    if(rolls.length>0){
      rolls.forEach(roll=>{
        h+='<div class="cart-item"><span class="item-name">ğŸ° '+roll.name+' <span style="font-size:11px;color:#fdba74">(ä¸å¯é…å¥—é¤)</span></span>';
        if(discount<1){
          const discPrice=Math.round(roll.price*discount);
          const discStr=discPrice.toLocaleString();
          const origStr=roll.price.toLocaleString();
          h+='<span class="item-price"><span class="price-orig">$'+origStr+'</span><span class="price-final">$'+discStr+'</span></span>';
        }else{
          h+='<span class="price-final">$'+roll.price.toLocaleString()+'</span>';
        }
        h+='</div>';
        teaItems.push(roll.name+' $'+(discount<1?Math.round(roll.price*discount):roll.price).toLocaleString());
      });
    }

    // é¡¯ç¤ºè´ˆé€å•†å“ï¼ˆä¸è¨ˆå…¥é‡‘é¡ï¼‰
    if(s.giftProduct&&s.giftQty>0){
      h+='<div class="cart-item" style="background:#2d3748"><span class="item-name">ğŸ è´ˆé€: '+s.giftProduct+' x'+s.giftQty+'</span><span class="price-final" style="color:#f59e0b">è´ˆé€</span></div>';
      teaItems.push('ğŸè´ˆé€: '+s.giftProduct+' x'+s.giftQty);
    }

    // é¡¯ç¤ºå°è¨ˆå’ŒæŠ˜æ‰£
    if(subtotal>0){
      h+='<div class="cart-item" style="border-top:1px dashed #4b5563;padding-top:6px;margin-top:4px"><span class="item-name">å°è¨ˆ</span><span class="price-orig">$'+subtotal.toLocaleString()+'</span></div>';

      // é¡¯ç¤ºæ•´å–®æŠ˜æ‰£ï¼ˆå¦‚æœæœ‰ï¼‰
      if(s.td<1){
        h+='<div class="cart-item"><span class="item-name">æ•´å–®æŠ˜æ‰£ ('+Math.round(s.td*100)+'æŠ˜)</span><span class="price-final" style="color:#f59e0b">å·²å¥—ç”¨</span></div>';
      }

      if(discount<1){
        const discountAmount=subtotal-finalTotal;
        h+='<div class="cart-item"><span class="item-name">æŠ˜æ‰£é‡‘é¡</span><span class="price-final" style="color:#f87171">-$'+discountAmount.toLocaleString()+'</span></div>';
        h+='<div class="cart-item" style="font-weight:bold"><span class="item-name">æŠ˜å¾Œç¸½é¡</span><span class="price-final" style="color:#4ade80">$'+finalTotal.toLocaleString()+'</span></div>';
        teaItems.push(discountLabel+' $'+finalTotal.toLocaleString());
      }else{
        h+='<div class="cart-item" style="font-weight:bold"><span class="item-name">ç¸½é¡</span><span class="price-final" style="color:#4ade80">$'+finalTotal.toLocaleString()+'</span></div>';
      }
    }
  }

  if(gt===0&&productItems.length===0&&teaItems.length===0){
    h+='<div style="color:#666;text-align:center;padding:20px;font-size:12px">è³¼ç‰©è»Šæ˜¯ç©ºçš„</div>';
  }

  // è¨ˆç®—åŸåƒ¹ç¸½é¡
  let originalTotal = 0;
  d.christmas.combo.forEach(p=>{const q=Q(p.id);if(q>0)originalTotal+=p.price*q});
  if(Q('CHOCO18')>0){const p=d.christmas.special[0];originalTotal+=p.orig*Q('CHOCO18')}
  d.christmas.box.forEach(p=>{const q=Q(p.id);if(q>0)originalTotal+=p.price*q});
  d.christmas.bag.forEach(p=>{const q=Q(p.id);if(q>0)originalTotal+=p.price*q});
  if(Q('CHOCO8')>0)originalTotal+=300*Q('CHOCO8');
  [{i:[...d.giftbox.general,...d.giftbox.double]},{i:[...d.cigare.original_small,...d.cigare.original_20,...d.cigare.original_large,...d.cigare.chocolate]},{i:d.autumn.items},{i:d.baton.items},{i:d.wood.items}].forEach(c=>{
    c.i.forEach(p=>{const q=Q(p.id);if(q>0)originalTotal+=p.price*q});
  });
  // ä¸‹åˆèŒ¶åŸåƒ¹è¨ˆç®—
  d.tea.cake.forEach(p=>{const q=Q(p.id);if(q>0)originalTotal+=p.price*q});
  d.tea.drink.forEach(p=>{const q=Q(p.id);if(q>0)originalTotal+=p.price*q});
  d.tea.roll.forEach(p=>{const q=Q(p.id);if(q>0)originalTotal+=p.price*q});

  const discount = originalTotal - gt;

  h+='<div class="divider"></div><div class="summary">';
  if(discount > 0){
    h+='<div class="summary-row"><span>åŸåƒ¹</span><span>$'+originalTotal.toLocaleString()+'</span></div>';

    // é¡¯ç¤ºæœƒå“¡æŠ˜æ‰£è³‡è¨Š
    let memberInfo='';
    const hasLowerDiscount=boxDis<genDis; // æª¢æŸ¥æ˜¯å¦æœ‰æ›´å„ªæƒ çš„æŠ˜æ‰£ï¼ˆå¦‚è–èª•89æŠ˜ï¼‰
    if(s.m==='blue'){
      if(hasLowerDiscount){
        memberInfo='ğŸ’è—é‘½æœƒå“¡'; // æœ‰æ›´å„ªæƒ æŠ˜æ‰£æ™‚ï¼Œåªé¡¯ç¤ºæœƒå“¡èº«ä»½
      }else{
        memberInfo=s.bd?'ğŸ’è—é‘½+ç”Ÿæ—¥æœˆ(9æŠ˜)':'ğŸ’è—é‘½(95æŠ˜)';
      }
    }else if(s.m==='white'){
      if(hasLowerDiscount&&s.bd){
        memberInfo='â¬œç™½é‘½æœƒå“¡'; // æœ‰æ›´å„ªæƒ æŠ˜æ‰£æ™‚ï¼Œåªé¡¯ç¤ºæœƒå“¡èº«ä»½
      }else{
        memberInfo=s.bd?'â¬œç™½é‘½+ç”Ÿæ—¥æœˆ(9æŠ˜)':'â¬œç™½é‘½';
      }
    }
    if(memberInfo&&s.td===1){
      h+='<div class="summary-row"><span>'+memberInfo+'</span><span style="color:#60a5fa">å·²å¥—ç”¨</span></div>';
    }

    // é¡¯ç¤ºæ•´å–®æŠ˜æ‰£ï¼ˆä¸‹åˆèŒ¶ï¼‰
    if(s.td<1){
      h+='<div class="summary-row"><span>æ•´å–®æŠ˜æ‰£('+Math.round(s.td*100)+'æŠ˜)</span><span style="color:#f59e0b">å·²å¥—ç”¨</span></div>';
    }

    h+='<div class="summary-row"><span>æŠ˜æ‰£</span><span style="color:#f87171">-$'+discount.toLocaleString()+'</span></div>';
  }
  h+='<div class="summary-row total"><span>æ‡‰ä»˜é‡‘é¡</span><span style="color:#4ade80">$'+gt.toLocaleString()+'</span></div></div></div>';

  // å„²å­˜çµå¸³æ•¸æ“šåˆ°å…¨åŸŸè®Šæ•¸ï¼ˆåŒ…å«æŠ˜æ‰£è³‡è¨Šï¼‰
  window.checkoutData = {
    productItems: productItems,
    teaItems: teaItems,
    total: gt,
    originalTotal: originalTotal,
    discount: discount
  };

  console.log('ğŸ“¦ è³¼ç‰©è»Šæ§‹å»ºå®Œæˆ');
  console.log('å•†å“æ•¸é‡:', productItems.length, 'é …ç›®:', productItems);
  console.log('ä¸‹åˆèŒ¶æ•¸é‡:', teaItems.length, 'é …ç›®:', teaItems);
  console.log('åŸåƒ¹:', originalTotal, 'æŠ˜æ‰£:', discount, 'ç¸½é‡‘é¡:', gt);

  // ä¸‹åˆèŒ¶åŠ è³¼ç¦®ç›’ä¹äº”æŠ˜å‹¾é¸æ¡†ï¼ˆåªåœ¨éä¸‹åˆèŒ¶é é¢é¡¯ç¤ºï¼‰
  if(s.tab !== 'tea'){
    h+='<div style="background:#374151;padding:10px;border-radius:6px;margin-bottom:10px">';
    h+='<label style="display:flex;align-items:center;gap:8px;cursor:pointer;color:#fde047;font-size:16px">';
    h+='<input type="checkbox"'+(s.teaGiftDiscount?' checked':'')+' onchange="window.S.teaGiftDiscount=this.checked;saveState();R()" style="width:18px;height:18px;cursor:pointer">';
    h+='<span>â˜• ä¸‹åˆèŒ¶åŠ è³¼ç¦®ç›’ä¹äº”æŠ˜</span>';
    h+='</label>';
    if(s.teaGiftDiscount){
      h+='<div style="margin-top:6px;padding:6px;background:#1f2937;border-radius:4px;font-size:13px;color:#e5e7eb">å‹¾é¸å¾Œï¼Œç¦®ç›’åŠå…¶ä»–åˆ†é å•†å“ï¼ˆè›‹æ²ã€ç§‹å†¬ã€é¤…ä¹¾æ£’ã€æœ¨ç›’ï¼‰äº«95æŠ˜ï¼Œè–èª•ç‰¹åƒ¹å•†å“é™¤å¤–</div>';
    }
    h+='</div>';
  }

    // æ‰‹å‹•ä¿®æ”¹é‡‘é¡å’Œå‚™è¨»å€å¡Š
    h+='<div style="background:#374151;padding:10px;border-radius:6px;margin-bottom:10px">';
    h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">';
    h+='<label style="color:#fde047;min-width:80px">ğŸ’µ çµå¸³é‡‘é¡:</label>';
    h+='<input type="number" value="'+(s.manualAmount>0?s.manualAmount:gt)+'" onchange="window.S.manualAmount=Math.max(0,+this.value);saveState();R()" style="flex:1;padding:6px;border-radius:4px;border:1px solid #4b5563;background:#1f2937;color:#fff;font-size:16px;font-weight:bold">';
    h+='<button onclick="window.S.manualAmount=0;saveState();R()" style="padding:6px 10px;background:#6b7280;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px">é‡ç½®</button>';
    h+='</div>';
    h+='<div style="display:flex;align-items:center;gap:8px">';
    h+='<label style="color:#fde047;min-width:80px">ğŸ“ å‚™è¨»:</label>';
h+='<input id="notesInput" type="text" value="'+s.notes+'" '+
   'oninput="window.S.notes=this.value;debouncedSave()" '+
   'placeholder="è¼¸å…¥å‚™è¨»..." '+
   'style="flex:1;padding:6px;border-radius:4px;border:1px solid #4b5563;background:#1f2937;color:#fff">';

    h+='</div></div>';

    const finalAmount=s.manualAmount>0?s.manualAmount:gt;
    h+='<button class="clear-btn" style="background:#16a34a" onclick="CO()">ğŸ’°çµå¸³ $'+finalAmount.toLocaleString()+'</button>';
    h+='<button class="clear-btn" style="background:#dc2626" onclick="window.S.cart={};window.S.tv=0;window.S.tb=0;window.S.td=1;window.S.xm=false;window.S.m=\'normal\';window.S.bd=false;window.S.manualAmount=0;window.S.notes=\'\';saveState();R()">ğŸ—‘ï¸æ¸…ç©ºè³¼ç‰©è»Š</button>';
  } // çµæŸè³¼ç‰©è»Šå€å¡Š

  document.getElementById('app').innerHTML=h;
}

loadRecords();
R();
</script>
</body>
</html>
