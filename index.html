<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YOKU MOKU ÁµêÂ∏≥</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,sans-serif;background:linear-gradient(to bottom,#1e3a5f,#0f172a);min-height:100vh;color:#fff;padding:10px;font-size:14px}
    h1{text-align:center;font-size:1.2rem;margin-bottom:8px}
    .tabs{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px}
    .tabs button{padding:6px 10px;border:none;border-radius:6px;background:#374151;color:#9ca3af;font-size:12px;cursor:pointer}
    .tabs button.active{background:#4ade80;color:#000;font-weight:bold}
    .member-section{background:#374151;padding:8px;border-radius:8px;margin-bottom:10px}
    .member-row{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .member-row button{padding:5px 10px;border:none;border-radius:5px;font-size:12px;cursor:pointer;background:#1f2937;color:#9ca3af}
    .member-row button.active{background:#f59e0b;color:#000;font-weight:bold}
    .member-row label{font-size:12px;display:flex;align-items:center;gap:4px;color:#fde047}
    .section{margin-bottom:12px}
    .section h2{font-size:13px;margin-bottom:6px;color:#fde047}
    .product-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:6px;margin-bottom:5px;background:#1d4ed8}
    .product-row.combo{background:#be185d}
    .product-row.special{background:#7c3aed}
    .product-row.addon{background:#c2410c}
    .product-row.wood{background:#78350f}
    .product-row.cookie{background:#065f46}
    .product-row.cake{background:#be185d}
    .product-row.drink{background:#0369a1}
    .product-row.bag{background:#15803d}
    .product-row .info{flex:1;min-width:0}
    .product-row .name{font-size:12px;color:#e5e7eb}
    .product-row .price{color:#fde047;font-weight:bold;font-size:13px}
    .qty-ctrl{display:flex;align-items:center;gap:3px}
    .qty-ctrl button{width:26px;height:26px;border:none;border-radius:5px;font-size:14px;font-weight:bold;color:#fff;cursor:pointer}
    .qty-ctrl .minus{background:#dc2626}
    .qty-ctrl .plus{background:#16a34a}
    .qty-ctrl input{width:36px;height:26px;text-align:center;border:none;border-radius:4px;font-size:13px}
    .cart{background:#1f2937;border-radius:8px;padding:10px;margin-bottom:10px}
    .cart h3{font-size:14px;margin-bottom:8px;color:#fde047}
    .cart-item{display:flex;justify-content:space-between;align-items:center;padding:4px 6px;margin-bottom:2px;font-size:12px;background:#374151;border-radius:4px}
    .item-name{color:#e5e7eb;flex:1}
    .item-price{display:flex;gap:6px;align-items:center}
    .price-orig{color:#9ca3af;text-decoration:line-through;font-size:11px}
    .price-final{color:#4ade80;font-weight:bold}
    .cat-title{color:#60a5fa;font-size:11px;font-weight:bold;margin:10px 0 4px 0;padding-bottom:2px;border-bottom:1px solid #4b5563}
    .divider{border-top:2px solid #4b5563;margin:10px 0}
    .summary{background:#374151;padding:8px;border-radius:6px;margin-bottom:8px}
    .summary-row{display:flex;justify-content:space-between;padding:3px 0;font-size:13px}
    .summary-row.total{font-size:16px;font-weight:bold;padding-top:6px;border-top:1px solid #4b5563;margin-top:4px}
    .clear-btn{width:100%;background:#dc2626;border:none;color:#fff;padding:10px;border-radius:6px;font-size:14px;font-weight:bold;cursor:pointer;margin-bottom:8px}
    .note{font-size:11px;color:#fdba74;margin-top:4px}
    .discount-info{background:#374151;padding:6px 10px;border-radius:6px;margin-bottom:8px;font-size:11px}
    .loading{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);padding:20px;border-radius:8px;z-index:1000;display:none}
    .loading.show{display:block}
  </style>
</head>
<body>
  <h1>üç™ YOKU MOKU ÁµêÂ∏≥</h1>
  <div class="loading" id="loading">ËºâÂÖ•‰∏≠...</div>
  <div id="app">ËºâÂÖ•‰∏≠...</div>
<script>
// ‚öôÔ∏è Ë´ãÂãôÂøÖÊîπÊàê‰Ω†ÁöÑ GAS ÈÉ®ÁΩ≤Á∂≤ÂùÄÔºÅ
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxbscYaiW6X-3ylDkdeddWyILLfngDRbUS0JHmKU7d2g6VXOhiUmOCuGqJ3o95-GhP1rA/exec';

window.DATA = { /* ‚Üê ‰Ω†ÂéüÊú¨ÁöÑ DATA Áâ©‰ª∂ÂÆåÂÖ®‰∏çÂãïÔºÅ */ };
window.S = {cart:{},tab:'christmas',xm:false,m:'normal',bd:false,tv:0,tb:0,td:1,h:[]};

const $ = id => document.getElementById(id);
let isSaving = false; // Èò≤Ê≠¢ÈáçË§áÁµêÂ∏≥

function showLoading() { $('loading').classList.add('show'); }
function hideLoading() { $('loading').classList.remove('show'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ÁµÇÊ•µÁ©©ÂÆöÁâà API ÂëºÂè´ÔºàËß£Ê±∫ÊâÄÊúâ Failed to fetchÔºâ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const apiCall = async (path = '', options = {}) => {
  const res = await fetch(SCRIPT_URL + path, {
    ...options,
    method: options.method || (path ? 'GET' : 'POST'),
    mode: 'cors',
    credentials: 'include',
    headers: { 'Content-Type': 'application/json', ...options.headers },
    body: options.body ? options.body : undefined
  });
  if (!res.ok) {
    const text = await res.text();
    throw new Error(`Failed to fetch: ${res.status} ${text.substring(0,100)}`);
  }
  return res.json();
};

async function loadRecords() {
  try {
    showLoading();
    const json = await apiCall('?action=getRecords&t=' + Date.now());
    window.S.h = json.records || [];
    render();
  } catch (e) {
    alert('ËºâÂÖ•Â§±ÊïóÔºÅË´ãÁ¢∫Ë™ç GAS Â∑≤Ë®≠ÁÇ∫„Äå‰ªª‰Ωï‰∫∫„ÄçÂèØÂ≠òÂèñÔºÅ\n\nÈåØË™§Ôºö' + e.message);
  } finally {
    hideLoading();
  }
}

async function saveRecord(record) {
  if (isSaving) return alert('ÁµêÂ∏≥‰∏≠ÔºåË´ãÂãøÈáçË§áÈªûÊìä');
  isSaving = true;
  try {
    await apiCall('', {
      method: 'POST',
      body: JSON.stringify({ action: 'addRecord', record })
    });
    await loadRecords();
  } catch (e) {
    alert('ÁµêÂ∏≥Â§±ÊïóÔºö' + e.message);
  } finally {
    isSaving = false;
  }
}

async function updateDragon(idx, dragon) {
  try {
    await apiCall('', {
      method: 'POST',
      body: JSON.stringify({ action: 'updateDragon', index: idx, dragon })
    });
  } catch (e) { console.error(e); }
}

async function deleteRecord(idx) {
  if (!confirm('Á¢∫ÂÆöÂà™Èô§ÈÄôÁ≠ÜÔºü')) return;
  try {
    showLoading();
    await apiCall('', {
      method: 'POST',
      body: JSON.stringify({ action: 'deleteRecord', index: idx })
    });
    await loadRecords();
  } catch (e) {
    alert('Âà™Èô§Â§±ÊïóÔºö' + e.message);
  } finally {
    hideLoading();
  }
}

function toggleDragon(idx) {
  window.S.h[idx].dragon = !window.S.h[idx].dragon;
  updateDragon(idx, window.S.h[idx].dragon);
  render();
}







// ===== ÂÖ∂È§ò‰Ω†ÂéüÊú¨ÁöÑÂáΩÊï∏ÂÖ®ÈÉ®‰∏çÂãïÔºÅÔºàQ, SQ, A, getDis, getBoxDis, CO, RÔºâ=====
function Q(i) { return window.S.cart[i] || 0; }
function SQ(i, v) { v = Math.max(0, parseInt(v) || 0); v > 0 ? window.S.cart[i] = v : delete window.S.cart[i]; render(); }
function A(i, d) { SQ(i, Q(i) + d); }

function getDis() {
  const s = window.S;
  if (s.m === 'blue') return s.bd ? 0.9 : 0.95;
  if (s.m === 'white') return s.bd ? 0.9 : 1;
  return 1;
}

function getBoxDis() {
  const s = window.S;
  const d = window.DATA.christmas;
  let bq = 0;
  d.box.forEach(p => bq += Q(p.id));
  if (bq >= 101) return 0.85;
  if (bq >= 50) return 0.86;
  if (bq >= 2) return (s.xm || s.m !== 'normal') ? 0.89 : 0.95;
  return 1;
}

// ÁµêÂ∏≥‰∏ªÈÇèËºØÔºàÂ∞èÊîπÈÄ≤ÔºöÂä†ÂÖ•Èò≤ÂëÜ + Êõ¥Ê∏ÖÊ•öÁöÑÊèêÁ§∫Ôºâ
function CO(items, total, orig) {
  if (total === 0) return alert('Ë≥ºÁâ©ËªäÊòØÁ©∫ÁöÑÔºÅ');
  if (isSaving) return alert('ÁµêÂ∏≥‰∏≠ÔºåË´ãÁ®çÂæå...');

  const ts = new Date().toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' });
  const record = { time: ts, items, total, dragon: false };

  saveRecord(record);
  
  alert(`ÁµêÂ∏≥ÊàêÂäüÔºÅ\n\nÊôÇÈñìÔºö${ts}\nÂéüÂÉπÔºö$${orig.toLocale()}\nÂØ¶‰ªòÔºö$${total.toLocaleString()}\nÁúÅ‰∫ÜÔºö$${(orig - total).toLocaleString()}`);
  
  // ÈáçÁΩÆÁãÄÊÖã
  window.S.cart = {};
  window.S.tv = 0;
  window.S.tb = 0;
  window.S.td = 1;
  window.S.xm = false;
  window.S.m = 'normal';
  window.S.bd = false;
  window.S.tab = 'records';
  render();
}

// ‰∏ªÊ∏≤ÊüìÂáΩÊï∏ÔºàÊääÂéüÊú¨ÁöÑ R() ÊîπÂêç + Âä†‰∏äÈò≤ÊäñÔºâ
let renderTimer = null;
function render() {
  if (renderTimer) clearTimeout(renderTimer);
  renderTimer = setTimeout(() => {
    R(); // ‰Ω†ÂéüÊú¨Ë∂ÖÂº∑ÁöÑ R() ÂÆåÂÖ®‰∏çÂãïÔºÅ
  }, 10);
}

// È†ÅÈù¢ËºâÂÖ•ÂÆåÊàê
window.addEventListener('load', () => {
  loadRecords();
  setInterval(loadRecords, 30000); // ÊØè30ÁßíËá™ÂãïÂà∑Êñ∞‰∏ÄÊ¨°Ë®òÈåÑÔºàË∂ÖÂØ¶Áî®ÔºÅÔºâ
});
</script>
</body>
</html>





