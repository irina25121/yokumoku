<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YOKU MOKU çµå¸³</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,sans-serif;background:#1e3a5f;min-height:100vh;color:#f5f0eb;padding:10px;font-size:18px;font-weight:bold}
    h1{text-align:center;font-size:1.8rem;margin-bottom:10px;color:#fff;font-weight:bold}
    .tabs{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px}
    .tabs button{padding:10px 16px;border:none;border-radius:6px;background:#374151;color:#fff;font-size:17px;cursor:pointer;font-weight:bold}
    .tabs button.active{background:#4ade80;color:#fff;font-weight:bold}
    .member-section{background:#374151;padding:10px;border-radius:8px;margin-bottom:10px}
    .member-row{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .member-row button{padding:8px 14px;border:none;border-radius:5px;font-size:16px;cursor:pointer;background:#4b5563;color:#f5f0eb}
    .member-row button.active{background:#6d6059;color:#f5f0eb;font-weight:bold}
    .member-row label{font-size:16px;display:flex;align-items:center;gap:4px;color:#fde047}
    .section{margin-bottom:12px}
    .section h2{font-size:17px;margin-bottom:6px;color:#f5f0eb;font-weight:bold}
    .product-row{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:6px;margin-bottom:5px;background:#1e3a8f}
    .product-row.combo{background:#be185d}
    .product-row.special{background:#7c3aed}
    .product-row.addon{background:#c2410c}
    .product-row.wood{background:#78350f}
    .product-row.cookie{background:#065f46}
    .product-row.cake{background:#854d0e}
    .product-row.drink{background:#0369a1}
    .product-row.bag{background:#15803d}
    .product-row.brown1{background:#b45309}
    .product-row.brown2{background:#92400e}
    .product-row.brown3{background:#78350f}
    .product-row.brown4{background:#713f12}
    .product-row.brown5{background:#a16207}
    .product-row.brown6{background:#854d0e}
    .product-row .info{flex:1;min-width:0}
    .product-row .name{font-size:17px;color:#f5f0eb;margin-bottom:6px}
    .product-row .price{color:#f5f0eb;font-weight:bold;font-size:18px}
    .qty-ctrl{display:flex;align-items:center;gap:3px}
    .qty-ctrl button{width:36px;height:36px;border:none;border-radius:5px;font-size:20px;font-weight:bold;color:#f5f0eb;cursor:pointer}
    .qty-ctrl .minus{background:#b7a7a8}
    .qty-ctrl .plus{background:#34251f}
    .qty-ctrl input{width:50px;height:36px;text-align:center;border:none;border-radius:4px;font-size:18px;background:#fff;color:#34251f}
    .cart{background:#1f2937;border-radius:8px;padding:10px;margin-bottom:10px}
    .cart h3{font-size:18px;margin-bottom:8px;color:#fde047;font-weight:bold}
    .cart-item{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;margin-bottom:2px;font-size:16px;background:#374151;border-radius:4px}
    .item-name{color:#e5e7eb;flex:1}
    .item-price{display:flex;gap:6px;align-items:center}
    .price-orig{color:#9ca3af;text-decoration:line-through;font-size:15px}
    .price-final{color:#4ade80;font-weight:bold;font-size:17px}
    .cat-title{color:#60a5fa;font-size:15px;font-weight:bold;margin:10px 0 4px 0;padding-bottom:2px;border-bottom:1px solid #4b5563}
    .divider{border-top:2px solid #4b5563;margin:10px 0}
    .summary{background:#374151;padding:8px;border-radius:6px;margin-bottom:8px}
    .summary-row{display:flex;justify-content:space-between;padding:4px 0;font-size:17px;color:#e5e7eb}
    .summary-row.total{font-size:24px;font-weight:bold;padding-top:6px;border-top:1px solid #4b5563;margin-top:4px}
    .clear-btn{width:100%;background:#6d6059;border:none;color:#f5f0eb;padding:14px;border-radius:6px;font-size:18px;font-weight:bold;cursor:pointer;margin-bottom:8px}
    .note{font-size:15px;color:#fdba74;margin-top:4px}
    .discount-info{background:#374151;padding:8px 12px;border-radius:6px;margin-bottom:8px;font-size:15px;color:#e5e7eb}
    .loading{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);padding:20px;border-radius:8px;z-index:1000;display:none}
    .loading.show{display:block}
    @media (max-width: 600px) {
      body{font-size:20px}
      h1{font-size:2rem}
      .tabs button{font-size:18px;padding:12px 18px}
      .product-row .name{font-size:18px}
      .product-row .price{font-size:20px}
      .cart h3{font-size:20px}
      .cart-item{font-size:18px}
      .summary-row{font-size:19px}
      .summary-row.total{font-size:26px}
      .clear-btn{font-size:20px;padding:16px}
      .qty-ctrl button{width:40px;height:40px;font-size:22px}
      .qty-ctrl input{width:55px;height:40px;font-size:20px}
    }
  </style>
</head>
<body>
  <h1>ğŸª YOKU MOKU çµå¸³</h1>
  <div class="loading" id="loading">è¼‰å…¥ä¸­...</div>
  <div id="app">è¼‰å…¥ä¸­...</div>
<script>
// âš™ï¸ è¨­å®šï¼šè«‹å°‡æ­¤ç¶²å€æ”¹ç‚ºæ‚¨çš„ Google Apps Script ç¶²å€
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzK4Qm1Y65JSbNSUxxrm1J5Ig_cOV_hAKGOTrb5VsXMyyxb-_go8YMAj3sgjvRLglV6Og/exec';

window.DATA={
  records:{name:'ğŸ“Šè¨˜éŒ„'},
  christmas:{
    name:'ğŸ„è–èª•',
    box:[
      {id:'YCG-DXM',name:'åŸå‘³é›ªèŒ„è›‹æ²20å…¥',price:950},
      {id:'YAN-A',name:'è–„ç‰‡æ¿ƒå·§é›™æ‹¼ç¦®ç›’24å…¥',price:850},
      {id:'YCN-A',name:'é›ªèŒ„è–„ç‰‡æ¿ƒå·§å¯Œæ‹¼ç¦®ç›’28å…¥',price:1380},
      {id:'YCN-B',name:'é›ªèŒ„è–„ç‰‡æ¿ƒå·§é›™æ‹¼ç¦®ç›’44å…¥',price:2050},
      {id:'YHD-A',name:'è‡»é¥Œæ¿ƒå·§ç¦®ç›’30å…¥',price:1500},
      {id:'YHD-B',name:'å–œé¥Œæ¿ƒå·§ç¦®ç›’50å…¥',price:2100}
    ],
    bag:[
      {id:'YCG-AXM',name:'åŸå‘³é›ªèŒ„è›‹æ²10å…¥',price:420},
      {id:'YBL-AXM',name:'æ¿ƒå·§é›™å±¤å·§å…‹åŠ›è–„ç‰‡é¤…ä¹¾12å…¥',price:420}
    ],
    combo:[
      {id:'XMAS-1',name:'è–èª•é›™æ‹¼å–®ç›’',price:1800},
      {id:'XMAS-2',name:'è–èª•é›™æ‹¼é›™ç›’',price:3500}
    ],
    special:[
      {id:'CHOCO18',name:'18å…¥å·§å…‹åŠ›é›ªèŒ„',price:660,orig:1120}
    ],
    addon:[
      {id:'CHOCO8',name:'8å…¥å·§å…‹åŠ›é›ªèŒ„(åŠ è³¼)',price:300}
    ]
  },
  giftbox:{
    name:'ğŸç¦®ç›’',
    general:[
      {id:'G1',name:'è‡»é¥Œæ¿ƒå·§ç¦®ç›’',price:1280},
      {id:'G3',name:'å–œé¥Œæ¿ƒå·§ç¦®ç›’',price:1980},
      {id:'G4',name:'ç››é¥Œæ¿ƒå·§ç¦®ç›’',price:2580},
      {id:'G6',name:'ç‰¹é¥Œæ¿ƒå·§ç¦®ç›’',price:2980}
    ],
    double:[
      {id:'G2',name:'é›ªèŒ„è–„ç‰‡æ¿ƒå·§é›™æ‹¼ç¦®ç›’',price:1880},
      {id:'G5',name:'é›ªèŒ„è–„ç‰‡æ¿ƒå·§ç‰¹é›™æ‹¼ç¦®ç›’',price:2880}
    ]
  },
  cigare:{
    name:'ğŸ¥šè›‹æ²',
    original_small:[
      {id:'C1',name:'åŸå‘³é›ªèŒ„è›‹æ²10å…¥',price:400},
      {id:'C2',name:'åŸå‘³é›ªèŒ„è›‹æ²14å…¥',price:620},
      {id:'PANDA16',name:'ç†Šè²“è¿·ä½ é›ªèŒ„16å…¥',price:580}
    ],
    original_20:[
      {id:'YCG-D',name:'åŸå‘³é›ªèŒ„è›‹æ²(20å…¥)',price:920},
      {id:'YCG-DR',name:'å–œé¥ŒåŸå‘³è›‹æ²(20å…¥)',price:920},
      {id:'YCG-DJ',name:'ã€å¯Œå£«å±±ã€‘åŸå‘³é›ªèŒ„è›‹æ²(20å…¥)',price:920},
      {id:'YCG-DTW',name:'ã€å°ç£é™å®šã€‘å¹¸ç¦æˆé›™åŸå‘³é›ªèŒ„è›‹æ²20å…¥',price:920}
    ],
    original_large:[
      {id:'C4',name:'åŸå‘³é›ªèŒ„è›‹æ²30å…¥',price:1320},
      {id:'C5',name:'åŸå‘³é›ªèŒ„è›‹æ²48å…¥',price:2020}
    ],
    chocolate:[
      {id:'C6',name:'å·§å…‹åŠ›é›ªèŒ„è›‹æ²8å…¥',price:480},
      {id:'C7',name:'å·§å…‹åŠ›é›ªèŒ„è›‹æ²18å…¥',price:1120}
    ]
  },
  autumn:{
    name:'ğŸ‚ç§‹å†¬è–„ç‰‡',
    items:[
      {id:'A1',name:'æ¿ƒå·§é›™å±¤å·§å…‹åŠ›è–„ç‰‡é¤…ä¹¾12å…¥',price:400},
      {id:'A2',name:'æ¿ƒå·§é›™å±¤å·§å…‹åŠ›é¤…ä¹¾ç¦®ç›’',price:820},
      {id:'A3',name:'æ¿ƒå·§é›™å±¤æä»è–„ç‰‡é¤…ä¹¾ç¦®ç›’',price:820},
      {id:'A5',name:'æ¿ƒå·§åœ“æœˆç…é¤…ä¹¾ç¦®ç›’',price:820},
      {id:'A4',name:'æ¿ƒå·§å¤å¨å¤·è±†å·§å…‹åŠ›é¤…ä¹¾ç¦®ç›’',price:920}
    ]
  },
  baton:{
    name:'ğŸªé¤…ä¹¾æ£’',
    items:[
      {id:'B1',name:'ç„™èŒ¶æ‹¿éµé¤…ä¹¾æ£’',price:520},
      {id:'B2',name:'å¥¶æ²¹é¤…ä¹¾æ£’',price:520}
    ]
  },
  wood:{
    name:'ğŸªµæœ¨ç›’',
    items:[
      {id:'W1',name:'æ²ç¦¾ç¦®ç›’-å°',price:580},
      {id:'W2',name:'æ²ç¦¾ç¦®ç›’-ä¸­',price:880},
      {id:'W3',name:'æ²ç¦¾ç¦®ç›’-å¤§',price:1580}
    ]
  },
  tea:{
    name:'â˜•ä¸‹åˆèŒ¶',
    cake:[
      {id:'T1',name:'å—é’å±±ç”Ÿä¹³æ²',price:220},
      {id:'T2',name:'è‰è“æµ·ç¶¿è›‹ç³•',price:280},
      {id:'T3',name:'å·§å…‹åŠ›å¥¶æ²¹è›‹ç³•',price:280},
      {id:'T4',name:'è’™å¸ƒæœ—è›‹ç³•',price:320},
      {id:'T5',name:'æŠ¹èŒ¶ææ‹‰ç±³è˜‡',price:320},
      {id:'T6',name:'ä¸€æ•´æ²å—å±±ç”Ÿä¹³æ²(å†·å‡)',price:920}
    ],
    drink:[
      {id:'D1',name:'ç¶“å…¸æ‰‹æ²–å’–å•¡',price:150},
      {id:'D2',name:'ä¼Šè—¤åœ’èœ‚èœœç´…èŒ¶',price:150},
      {id:'D3',name:'ä¼Šè—¤åœ’ç‰¹é¸æ—¥å¼ç¶ èŒ¶',price:150}
    ]
  }
};

window.S={cart:{},tab:'christmas',xm:false,m:'normal',bd:false,tv:0,tb:0,td:1,h:[]};

function formatTime(date){
  const h=date.getHours();
  const m=date.getMinutes();
  const period=h<12?'ä¸Šåˆ':'ä¸‹åˆ';
  const h12=h%12||12;
  const mm=m<10?'0'+m:m;
  return period+h12+':'+mm;
}

function formatDateTime(date){
  const y=date.getFullYear();
  const mo=date.getMonth()+1;
  const d=date.getDate();
  return y+'/'+mo+'/'+d+' '+formatTime(date);
}

function showLoading(){document.getElementById('loading').classList.add('show')}
function hideLoading(){document.getElementById('loading').classList.remove('show')}

async function loadRecords(){
  if(SCRIPT_URL==='YOUR_GOOGLE_APPS_SCRIPT_URL_HERE'){
    console.log('è«‹å…ˆè¨­å®š Google Apps Script URL');
    return;
  }
  try{
    showLoading();
    const res=await fetch(SCRIPT_URL+'?action=getRecords');
    const data=await res.json();
    window.S.h=(data.records||[]).map(r=>{
      // ç¢ºä¿æ™‚é–“æ ¼å¼æ­£ç¢º
      let timeStr = r.time;
      if(timeStr && typeof timeStr === 'string' && timeStr.includes('T')){
        // å¦‚æœæ˜¯ISOæ ¼å¼ï¼Œè½‰æ›æˆæœ¬åœ°æ ¼å¼
        const d = new Date(timeStr);
        timeStr = formatDateTime(d);
      }
      return {
        ...r,
        time: timeStr,
        dragon: r.dragon||false,
        productItems: r.productItems||[],
        teaItems: r.teaItems||[]
      };
    });
    hideLoading();
    R();
  }catch(e){
    hideLoading();
    console.error('è¼‰å…¥è¨˜éŒ„å¤±æ•—',e);
  }
}

async function saveRecord(record){
  try{
    console.log('ğŸ’¾ é–‹å§‹å„²å­˜è¨˜éŒ„åˆ° Google Sheets');
    console.log('SCRIPT_URL:', SCRIPT_URL);
    console.log('è¨˜éŒ„å…§å®¹:', record);

    if(SCRIPT_URL==='YOUR_GOOGLE_APPS_SCRIPT_URL_HERE'){
      alert('âš ï¸ è«‹å…ˆè¨­å®š Google Apps Script URLï¼\nåœ¨ HTML ç¬¬ 83 è¡Œ');
      hideLoading();
      return;
    }

    showLoading();
    const body = new URLSearchParams();
    body.append('action','addRecord');
    body.append('record', JSON.stringify(record));

    console.log('ç™¼é€è«‹æ±‚åˆ°:', SCRIPT_URL);
    const response = await fetch(SCRIPT_URL,{method:'POST',body:body});
    console.log('å„²å­˜å›æ‡‰ç‹€æ…‹:', response.status);

    const responseText = await response.text();
    console.log('å„²å­˜å›æ‡‰å…§å®¹:', responseText);

    await loadRecords();
    hideLoading();
  }catch(e){
    hideLoading();
    console.error('å„²å­˜éŒ¯èª¤:', e);
    alert('å„²å­˜å¤±æ•—ï¼š'+e.message);
  }
}

function toggleDragon(idx){
  window.S.h[idx].dragon=!window.S.h[idx].dragon;
  R();
}

async function deleteRecord(idx){
  if(!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„ï¼Ÿ')) return;
  try{
    showLoading();
    const body = new URLSearchParams();
    body.append('action','deleteRecord');
    body.append('index', String(idx));
    await fetch(SCRIPT_URL,{method:'POST',body:body});
    await loadRecords();
    hideLoading();
  }catch(e){
    hideLoading();
    alert('åˆªé™¤å¤±æ•—ï¼š'+e.message);
  }
}

function Q(i){return window.S.cart[i]||0}
function SQ(i,v){v=Math.max(0,parseInt(v)||0);v>0?window.S.cart[i]=v:delete window.S.cart[i];R()}
function A(i,d){SQ(i,Q(i)+d)}
function getDis(){const s=window.S;if(s.m==='blue')return s.bd?0.9:0.95;if(s.m==='white')return s.bd?0.9:1;return 1}
function getBoxDis(){const s=window.S;const d=window.DATA.christmas;let bq=0;d.box.forEach(p=>bq+=Q(p.id));if(bq>=101)return 0.85;if(bq>=50)return 0.86;if(bq>=2)return(s.xm||s.m!=='normal')?0.89:0.95;return 1}

// å…¨åŸŸè®Šæ•¸å­˜å„²çµå¸³æ•¸æ“š
window.checkoutData = {productItems:[], teaItems:[], total:0};

function CO(){
  const {productItems, teaItems, total} = window.checkoutData;

  console.log('=== çµå¸³è³‡æ–™ ===');
  console.log('å•†å“é …ç›®:', productItems);
  console.log('ä¸‹åˆèŒ¶é …ç›®:', teaItems);
  console.log('ç¸½é‡‘é¡:', total);

  const allItems=[...productItems,...teaItems];
  if(allItems.length===0){alert('è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼');return}
  const now=new Date();
  const ts=formatDateTime(now);
  const record={time:ts,productItems:productItems,teaItems:teaItems,total:total,dragon:false};

  console.log('æº–å‚™å„²å­˜çš„è¨˜éŒ„:', record);
  saveRecord(record);
  if(total===0){
    alert('âœ…çµå¸³æˆåŠŸï¼\næ™‚é–“ï¼š'+formatTime(now)+'\nç¸½é‡‘é¡ï¼š$0ï¼ˆä½¿ç”¨åˆ¸ï¼‰\nå…± '+allItems.length+' é …å•†å“');
  }else{
    alert('âœ…çµå¸³æˆåŠŸï¼\næ™‚é–“ï¼š'+formatTime(now)+'\nç¸½é‡‘é¡ï¼š$'+total.toLocaleString()+'\nå…± '+allItems.length+' é …å•†å“');
  }
  window.S.cart={};window.S.tv=0;window.S.tb=0;window.S.td=1;window.S.xm=false;window.S.m='normal';window.S.bd=false;window.S.tab='records';R();
}

function R(){
  const s=window.S,d=window.DATA;
  const Q2=(i,dis)=>'<div class="qty-ctrl"><button class="minus" onclick="A(\''+i+'\',-1)">-</button><input type="number" value="'+Q(i)+'" onchange="SQ(\''+i+'\',this.value)"><button class="plus" onclick="A(\''+i+'\',1)"'+(dis?' style="background:#666"':'')+'>+</button></div>';

  let h='<div class="tabs">'+Object.keys(d).map(k=>'<button class="'+(s.tab===k?'active':'')+'" onclick="window.S.tab=\''+k+'\';R()">'+d[k].name+'</button>').join('')+'</div>';

  if(s.tab==='records'){
    const td=new Date().toLocaleDateString('zh-TW');
    const tt=s.h.reduce((sum,r)=>sum+r.total,0);
    const dragonTotal=s.h.filter(r=>r.dragon).reduce((sum,r)=>sum+r.total,0);
    const dragonCount=s.h.filter(r=>r.dragon).length;
    h+='<div class="discount-info">ğŸ“…'+td+' | å…±'+s.h.length+'ç­† | ç‡Ÿæ¥­é¡$'+tt.toLocaleString();
    if(dragonCount>0)h+=' | ç¥¥é¾:'+dragonCount+'ç­†/$'+dragonTotal.toLocaleString();
    h+='</div><div style="background:#1f2937;border-radius:8px;padding:10px;margin-bottom:10px;max-height:70vh;overflow-y:auto">';
    if(s.h.length===0){
      h+='<div style="color:#666;text-align:center;padding:20px">ä»Šå¤©é‚„æ²’æœ‰çµå¸³è¨˜éŒ„</div>';
    }else{
      s.h.forEach((r,i)=>{
        const n=i+1;
        const hasProducts=r.productItems&&r.productItems.length>0;
        const hasTea=r.teaItems&&r.teaItems.length>0;
        h+='<div style="background:#374151;border-radius:6px;padding:10px;margin-bottom:8px'+(r.dragon?';border:2px solid #fbbf24':'')+'">';
        h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid #4b5563">';
        h+='<div style="display:flex;align-items:center;gap:8px">';
        h+='<b style="color:#fde047;font-size:17px">#'+n+'</b>';
        h+='<span style="color:#9ca3af;font-size:14px">'+r.time+'</span>';
        h+='<label style="display:flex;align-items:center;gap:4px;font-size:14px;color:#fde047;cursor:pointer;margin-left:8px">';
        h+='<input type="checkbox"'+(r.dragon?' checked':'')+' onchange="toggleDragon('+i+')" style="cursor:pointer">ç¥¥é¾</label>';
        h+='</div><div style="display:flex;align-items:center;gap:8px">';
        h+='<b style="color:#4ade80;font-size:20px">$'+r.total.toLocaleString()+'</b>';
        h+='<button onclick="deleteRecord('+i+')" style="background:#79635b;border:none;color:#fff;padding:6px 10px;border-radius:4px;cursor:pointer;font-size:18px">ğŸ—‘ï¸</button>';
        h+='</div></div>';
        h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:14px">';
        h+='<div style="background:#1f2937;padding:8px;border-radius:4px">';
        h+='<div style="color:#60a5fa;font-weight:bold;margin-bottom:4px;font-size:15px">ğŸª å•†å“</div>';
        if(hasProducts){
          r.productItems.forEach(it=>h+='<div style="color:#e5e7eb;margin:2px 0;padding-left:4px;font-size:13px">â€¢ '+it+'</div>');
        }else{
          h+='<div style="color:#666;font-style:italic;font-size:13px">ç„¡</div>';
        }
        h+='</div>';
        h+='<div style="background:#1f2937;padding:8px;border-radius:4px">';
        h+='<div style="color:#fbbf24;font-weight:bold;margin-bottom:4px;font-size:15px">â˜• ä¸‹åˆèŒ¶</div>';
        if(hasTea){
          r.teaItems.forEach(it=>h+='<div style="color:#e5e7eb;margin:2px 0;padding-left:4px;font-size:13px">â€¢ '+it+'</div>');
        }else{
          h+='<div style="color:#666;font-style:italic;font-size:13px">ç„¡</div>';
        }
        h+='</div></div></div>';
      });
    }
    h+='</div>';
  }else if(s.tab==='christmas'){
    const dd=d.christmas;
    h+='<div class="member-section"><div class="member-row"><button class="'+(!s.xm&&s.m==='normal'?'active':'')+'" onclick="window.S.xm=false;window.S.m=\'normal\';R()">ä¸€èˆ¬</button><button class="'+(s.xm||s.m!=='normal'?'active':'')+'" onclick="window.S.xm=true;R()">ğŸ‘‘æœƒå“¡</button></div></div>';
    h+='<div class="discount-info">ğŸ“¦ç›’è£:2ç›’'+(s.xm||s.m!=='normal'?'89':'95')+'æŠ˜/50ç›’86æŠ˜/101ç›’85æŠ˜ | ğŸè¢‹è£:3è¢‹ä»¥ä¸Šæ¯è¢‹$400</div>';
    h+='<div class="section"><h2>è–èª•é›™æ‹¼</h2>'+dd.combo.map(p=>'<div class="product-row combo"><div class="info"><div class="name">'+p.name+'</div><div class="price">$'+p.price.toLocaleString()+'</div></div>'+Q2(p.id)+'</div>').join('')+'</div>';
    h+='<div class="section"><h2>å·§å…‹åŠ›ç‰¹æƒ </h2>'+dd.special.map(p=>'<div class="product-row special"><div class="info"><div class="name">'+p.name+'</div><div class="price"><s style="color:#999">$'+p.orig.toLocaleString()+'</s> â†’ $'+p.price.toLocaleString()+'</div></div>'+Q2(p.id)+'</div>').join('')+'</div>';
    h+='<div class="section"><h2>ç›’è£</h2>'+dd.box.map(p=>'<div class="product-row brown5"><div class="info"><div class="name">'+p.name+'</div><div class="price">$'+p.price.toLocaleString()+'</div></div>'+Q2(p.id)+'</div>').join('')+'</div>';
    h+='<div class="section"><h2>è¢‹è£</h2>'+dd.bag.map(p=>'<div class="product-row bag"><div class="info"><div class="name">'+p.name+'</div><div class="price">$'+p.price.toLocaleString()+'</div></div>'+Q2(p.id)+'</div>').join('')+'</div>';
    h+='<div class="section"><h2>åŠ è³¼</h2>'+dd.addon.map(p=>'<div class="product-row addon"><div class="info"><div class="name">'+p.name+'</div><div class="price">+$'+p.price.toLocaleString()+'</div></div>'+Q2(p.id,!(d.christmas.box.some(x=>Q(x.id)>0)||d.christmas.bag.some(x=>Q(x.id)>0)||d.christmas.combo.some(x=>Q(x.id)>0)))+'</div>').join('')+'<div class="note">â€»éœ€å…ˆé¸è³¼è–èª•å•†å“æ‰èƒ½åŠ è³¼</div></div>';
  }else if(s.tab==='giftbox'){
    const gg=d.giftbox;
    h+='<div class="member-section"><div class="member-row"><button class="'+(s.m==='normal'?'active':'')+'" onclick="window.S.m=\'normal\';R()">ä¸€èˆ¬</button><button class="'+(s.m==='blue'?'active':'')+'" onclick="window.S.m=\'blue\';R()">ğŸ’è—é‘½</button><button class="'+(s.m==='white'?'active':'')+'" onclick="window.S.m=\'white\';R()">â¬œç™½é‘½</button><label><input type="checkbox"'+(s.bd?' checked':'')+' onchange="window.S.bd=this.checked;R()">ç”Ÿæ—¥æœˆ</label></div></div>';
    h+='<div class="discount-info">'+(s.m==='blue'?'ğŸ’è—é‘½:'+(s.bd?'ç”Ÿæ—¥æœˆ9æŠ˜':'95æŠ˜'):s.m==='white'?'â¬œç™½é‘½:'+(s.bd?'ç”Ÿæ—¥æœˆ9æŠ˜':'åŸåƒ¹'):'ä¸€èˆ¬:åŸåƒ¹')+'</div>';
    h+='<div class="section"><h2>ğŸä¸€èˆ¬ç¦®ç›’</h2>'+gg.general.map(p=>'<div class="product-row brown2"><div class="info"><div class="name">'+p.name+'</div><div class="price">$'+p.price.toLocaleString()+'</div></div>'+Q2(p.id)+'</div>').join('')+'</div>';
    h+='<div class="section"><h2>ğŸ€é›™æ‹¼ç¦®ç›’</h2>'+gg.double.map(p=>'<div class="product-row brown6"><div class="info"><div class="name">'+p.name+'</div><div class="price">$'+p.price.toLocaleString()+'</div></div>'+Q2(p.id)+'</div>').join('')+'</div>';
  }else if(s.tab==='tea'){
    const tt=d.tea;
    h+='<div class="discount-info">â˜•1è›‹ç³•+1é£²æ–™=1å¥—,é£²æ–™-$30</div>';
    h+='<div style="background:#374151;padding:8px;border-radius:6px;margin-bottom:8px;font-size:12px"><b style="display:block;margin-bottom:6px;color:#fde047">æ•´å–®æŠ˜æ‰£:</b>';
    h+='<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">'+[1,0.95,0.9,0.85,0.7].map(v=>'<button style="padding:4px 12px;border:none;border-radius:4px;cursor:pointer;'+(s.td===v?'background:#f59e0b;color:#fff;font-weight:bold':'background:#1f2937;color:#fff')+'" onclick="window.S.td='+v+';R()">'+(v===1?'ç„¡':Math.round(v*100)+'æŠ˜')+'</button>').join('')+'</div>';
    h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><label style="min-width:80px">ğŸ‘‘è²´è³“åˆ¸:</label><div class="qty-ctrl"><button class="minus" onclick="window.S.tv=Math.max(0,window.S.tv-1);R()">-</button><input type="number" value="'+s.tv+'" onchange="window.S.tv=Math.max(0,+this.value);R()" style="width:50px"><button class="plus" onclick="window.S.tv++;R()">+</button></div><span>å¥—</span></div>';
    h+='<div style="display:flex;align-items:center;gap:8px"><label style="min-width:80px">ğŸ‚ç”Ÿæ—¥ç¦®:</label><div class="qty-ctrl"><button class="minus" onclick="window.S.tb=Math.max(0,window.S.tb-1);R()">-</button><input type="number" value="'+s.tb+'" onchange="window.S.tb=Math.max(0,+this.value);R()" style="width:50px"><button class="plus" onclick="window.S.tb++;R()">+</button></div><span>å¥—</span></div></div>';
    h+='<div class="section"><h2>è›‹ç³•</h2>'+tt.cake.map(p=>'<div class="product-row cake"><div class="info"><div class="name">'+p.name+'</div><div class="price">$'+p.price.toLocaleString()+'</div></div>'+Q2(p.id)+'</div>').join('')+'</div>';
    h+='<div class="section"><h2>é£²å“</h2>'+tt.drink.map(p=>'<div class="product-row drink"><div class="info"><div class="name">'+p.name+'</div><div class="price">$'+p.price.toLocaleString()+'</div></div>'+Q2(p.id)+'</div>').join('')+'</div>';
  }else if(s.tab==='cigare'){
    const cc=d.cigare;
    h+='<div class="member-section"><div class="member-row"><button class="'+(s.m==='normal'?'active':'')+'" onclick="window.S.m=\'normal\';R()">ä¸€èˆ¬</button><button class="'+(s.m==='blue'?'active':'')+'" onclick="window.S.m=\'blue\';R()">ğŸ’è—é‘½</button><button class="'+(s.m==='white'?'active':'')+'" onclick="window.S.m=\'white\';R()">â¬œç™½é‘½</button><label><input type="checkbox"'+(s.bd?' checked':'')+' onchange="window.S.bd=this.checked;R()">ç”Ÿæ—¥æœˆ</label></div></div>';
    h+='<div class="discount-info">'+(s.m==='blue'?'ğŸ’è—é‘½:'+(s.bd?'ç”Ÿæ—¥æœˆ9æŠ˜':'95æŠ˜'):s.m==='white'?'â¬œç™½é‘½:'+(s.bd?'ç”Ÿæ—¥æœˆ9æŠ˜':'åŸåƒ¹'):'ä¸€èˆ¬:åŸåƒ¹')+'</div>';
    h+='<div class="section"><h2>åŸå‘³ 10/14/16å…¥</h2>'+cc.original_small.map(p=>'<div class="product-row brown1"><div class="info"><div class="name">'+p.name+'</div><div class="price">$'+p.price.toLocaleString()+'</div></div>'+Q2(p.id)+'</div>').join('')+'</div>';
    h+='<div class="section"><h2>åŸå‘³ 20å…¥</h2>'+cc.original_20.map(p=>'<div class="product-row brown2"><div class="info"><div class="name">'+p.name+'</div><div class="price">$'+p.price.toLocaleString()+'</div></div>'+Q2(p.id)+'</div>').join('')+'</div>';
    h+='<div class="section"><h2>åŸå‘³ 30/48å…¥</h2>'+cc.original_large.map(p=>'<div class="product-row brown3"><div class="info"><div class="name">'+p.name+'</div><div class="price">$'+p.price.toLocaleString()+'</div></div>'+Q2(p.id)+'</div>').join('')+'</div>';
    h+='<div class="section"><h2>å·§å…‹åŠ›</h2>'+cc.chocolate.map(p=>'<div class="product-row brown4"><div class="info"><div class="name">'+p.name+'</div><div class="price">$'+p.price.toLocaleString()+'</div></div>'+Q2(p.id)+'</div>').join('')+'</div>';
  }else{
    const cc=d[s.tab];
    const st=s.tab==='wood'?'wood':s.tab==='baton'?'cookie':'';
    h+='<div class="member-section"><div class="member-row"><button class="'+(s.m==='normal'?'active':'')+'" onclick="window.S.m=\'normal\';R()">ä¸€èˆ¬</button><button class="'+(s.m==='blue'?'active':'')+'" onclick="window.S.m=\'blue\';R()">ğŸ’è—é‘½</button><button class="'+(s.m==='white'?'active':'')+'" onclick="window.S.m=\'white\';R()">â¬œç™½é‘½</button><label><input type="checkbox"'+(s.bd?' checked':'')+' onchange="window.S.bd=this.checked;R()">ç”Ÿæ—¥æœˆ</label></div></div>';
    h+='<div class="discount-info">'+(s.m==='blue'?'ğŸ’è—é‘½:'+(s.bd?'ç”Ÿæ—¥æœˆ9æŠ˜':'95æŠ˜'):s.m==='white'?'â¬œç™½é‘½:'+(s.bd?'ç”Ÿæ—¥æœˆ9æŠ˜':'åŸåƒ¹'):'ä¸€èˆ¬:åŸåƒ¹')+'</div>';
    h+='<div class="section"><h2>'+cc.name+'</h2>'+cc.items.map(p=>'<div class="product-row '+st+'"><div class="info"><div class="name">'+p.name+'</div><div class="price">$'+p.price.toLocaleString()+'</div></div>'+Q2(p.id)+'</div>').join('')+'</div>';
  }

  let gt=0;const boxDis=getBoxDis();const genDis=getDis();let productItems=[],teaItems=[];
  h+='<div class="cart"><h3>ğŸ›’ è³¼ç‰©è»Š</h3>';

  if(d.christmas.combo.some(p=>Q(p.id)>0)){
    h+='<div class="cat-title">è–èª•é›™æ‹¼</div>';
    d.christmas.combo.forEach(p=>{const q=Q(p.id);if(q>0){const t=p.price*q;h+='<div class="cart-item"><span class="item-name">'+p.name+' x'+q+'</span><span class="price-final">$'+t.toLocaleString()+'</span></div>';gt+=t;productItems.push(p.name+' x'+q+' $'+t.toLocaleString())}});
  }

  if(Q('CHOCO18')>0){
    const p=d.christmas.special[0];const q=Q('CHOCO18');const f=p.price*q;
    h+='<div class="cat-title">å·§å…‹åŠ›ç‰¹æƒ </div><div class="cart-item"><span class="item-name">'+p.name+' x'+q+'</span><span class="price-final">$'+f.toLocaleString()+'</span></div>';
    gt+=f;productItems.push(p.name+' x'+q+' $'+f.toLocaleString());
  }

  let boxCnt=0,boxOrig=0;
  d.christmas.box.forEach(p=>{const q=Q(p.id);if(q>0){boxCnt+=q;boxOrig+=p.price*q}});
  if(boxCnt>0){
    const boxFinal=Math.round(boxOrig*boxDis);
    h+='<div class="cat-title">è–èª•ç›’è£'+(boxDis<1?' ('+Math.round(boxDis*100)+'æŠ˜)':'')+'</div>';
    d.christmas.box.forEach(p=>{const q=Q(p.id);if(q>0){const f=Math.round(p.price*q*boxDis);h+='<div class="cart-item"><span class="item-name">'+p.name+' x'+q+'</span><span class="price-final">$'+f.toLocaleString()+'</span></div>';productItems.push(p.name+' x'+q+' $'+f.toLocaleString())}});
    gt+=boxFinal;
  }

  let bagCnt=0,bagOrig=0;
  d.christmas.bag.forEach(p=>{const q=Q(p.id);if(q>0){bagCnt+=q;bagOrig+=p.price*q}});
  if(bagCnt>0){
    const bagFinal=bagCnt>=3?bagCnt*400:bagOrig;
    h+='<div class="cat-title">è–èª•è¢‹è£'+(bagCnt>=3?' (æ¯è¢‹$400)':'')+'</div>';
    d.christmas.bag.forEach(p=>{const q=Q(p.id);if(q>0){const f=bagCnt>=3?400*q:p.price*q;h+='<div class="cart-item"><span class="item-name">'+p.name+' x'+q+'</span><span class="price-final">$'+f.toLocaleString()+'</span></div>';productItems.push(p.name+' x'+q+' $'+f.toLocaleString())}});
    gt+=bagFinal;
  }

  if(Q('CHOCO8')>0){
    const q=Q('CHOCO8');const t=300*q;
    h+='<div class="cat-title">åŠ è³¼</div><div class="cart-item"><span class="item-name">8å…¥å·§å…‹åŠ›é›ªèŒ„ x'+q+'</span><span class="price-final">$'+t.toLocaleString()+'</span></div>';
    gt+=t;productItems.push('8å…¥å·§å…‹åŠ›é›ªèŒ„(åŠ è³¼) x'+q+' $'+t.toLocaleString());
  }

  [{i:[...d.giftbox.general,...d.giftbox.double]},{i:[...d.cigare.original_small,...d.cigare.original_20,...d.cigare.original_large,...d.cigare.chocolate]},{i:d.autumn.items},{i:d.baton.items},{i:d.wood.items}].forEach(c=>{
    let cf=0;const ci=[];
    c.i.forEach(p=>{const q=Q(p.id);if(q>0){const f=Math.round(p.price*q*genDis);cf+=f;ci.push({p:p,q:q,f:f})}});
    if(ci.length>0){
      ci.forEach(it=>{h+='<div class="cart-item"><span class="item-name">'+it.p.name+' x'+it.q+'</span><span class="price-final">$'+it.f.toLocaleString()+'</span></div>';productItems.push(it.p.name+' x'+it.q+' $'+it.f.toLocaleString())});
      gt+=cf;
    }
  });

  let cq=0,ct=0,dq=0,dt=0;
  d.tea.cake.forEach(p=>{const q=Q(p.id);if(q>0){cq+=q;ct+=p.price*q}});
  d.tea.drink.forEach(p=>{const q=Q(p.id);if(q>0){dq+=q;dt+=p.price*q}});
  if(cq>0||dq>0){
    const sets=Math.min(cq,dq);const free=Math.min(sets,s.tv+s.tb);const paid=Math.max(0,sets-free);
    const ac=cq>0?ct/cq:0;const ad=dq>0?dt/dq:150;const base=ac+ad;
    const paidT=paid*(base-30)*s.td;const extraC=Math.max(0,cq-sets);const extraD=Math.max(0,dq-sets);
    const extraT=(extraC*ac+extraD*ad)*s.td;const tf=Math.round(paidT+extraT);
    h+='<div class="cat-title">ä¸‹åˆèŒ¶ ('+sets+'å¥—'+(free>0?' å«å…è²»'+free+'å¥—':'')+(s.td<1?' '+Math.round(s.td*100)+'æŠ˜':'')+')</div>';
    d.tea.cake.forEach(p=>{const q=Q(p.id);if(q>0){h+='<div class="cart-item"><span class="item-name">'+p.name+' x'+q+'</span><span class="price-final">$'+(p.price*q).toLocaleString()+'</span></div>';teaItems.push(p.name+' x'+q+' $'+(p.price*q).toLocaleString())}});
    d.tea.drink.forEach(p=>{const q=Q(p.id);if(q>0){h+='<div class="cart-item"><span class="item-name">'+p.name+' x'+q+'</span><span class="price-final">$'+(p.price*q).toLocaleString()+'</span></div>';teaItems.push(p.name+' x'+q+' $'+(p.price*q).toLocaleString())}});
    if(sets>0){
      let setDesc='ä¸‹åˆèŒ¶'+sets+'å¥—';
      if(free>0)setDesc+=' (å…è²»'+free+'å¥—)';
      if(s.td<1)setDesc+=' ('+Math.round(s.td*100)+'æŠ˜)';
      setDesc+=' $'+tf.toLocaleString();
      teaItems.push(setDesc);
    }
    gt+=tf;
  }

  if(gt===0&&productItems.length===0&&teaItems.length===0){
    h+='<div style="color:#666;text-align:center;padding:20px;font-size:12px">è³¼ç‰©è»Šæ˜¯ç©ºçš„</div>';
  }

  h+='<div class="divider"></div><div class="summary"><div class="summary-row total"><span>æ‡‰ä»˜é‡‘é¡</span><span style="color:#4ade80">$'+gt.toLocaleString()+'</span></div></div></div>';

  // å„²å­˜çµå¸³æ•¸æ“šåˆ°å…¨åŸŸè®Šæ•¸
  window.checkoutData = {productItems: productItems, teaItems: teaItems, total: gt};

  console.log('ğŸ“¦ è³¼ç‰©è»Šæ§‹å»ºå®Œæˆ');
  console.log('å•†å“æ•¸é‡:', productItems.length, 'é …ç›®:', productItems);
  console.log('ä¸‹åˆèŒ¶æ•¸é‡:', teaItems.length, 'é …ç›®:', teaItems);
  console.log('ç¸½é‡‘é¡:', gt);

  h+='<button class="clear-btn" style="background:#16a34a" onclick="CO()">ğŸ’°çµå¸³ $'+gt.toLocaleString()+'</button>';
  h+='<button class="clear-btn" style="background:#dc2626" onclick="window.S.cart={};window.S.tv=0;window.S.tb=0;window.S.td=1;window.S.xm=false;window.S.m=\'normal\';window.S.bd=false;R()">ğŸ—‘ï¸æ¸…ç©ºè³¼ç‰©è»Š</button>';

  document.getElementById('app').innerHTML=h;
}

loadRecords();
R();
</script>
</body>
</html>
